(window.webpackJsonp=window.webpackJsonp||[]).push([[304],{762:function(s,t,a){"use strict";a.r(t);var n=a(1),r=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h3",{attrs:{id:"一、risc-v-assembly"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、risc-v-assembly"}},[s._v("#")]),s._v(" 一、RISC-V assembly")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("实验描述")]),s._v(" "),t("ul",[t("li",[s._v("了解一些RISC-V程序集很重要，你在6.004中接触过这些程序集。在你的xv6存储库中有一个文件user/call.c。使用make fs.img命令对其进行编译，并在user/call.asm中生成程序的可读汇编版本。")]),s._v(" "),t("li",[s._v("阅读call.asm中函数g、f和main的代码。RISC-V的说明手册在参考地址上。以下是你应该回答的一些问题(将答案存储在文件answers-traps.txt中)：")])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[s._v("user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("_call"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("     file format elf64"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("littleriscv\n\nDisassembly of section "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("text"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0000000000000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("g"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kernel/param.h"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kernel/types.h"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kernel/stat.h"')])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token macro property"}},[t("span",{pre:!0,attrs:{class:"token directive-hash"}},[s._v("#")]),t("span",{pre:!0,attrs:{class:"token directive keyword"}},[s._v("include")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"user/user.h"')])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("g")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1141")]),s._v("                \taddi\tsp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\te422                \tsd\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0800")]),s._v("                \taddi\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("250")]),s._v("d                \taddiw\ta0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6422")]),s._v("                \tld\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0141")]),s._v("                \taddi\tsp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n   c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v("                \tret\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000000000000000")]),s._v("e "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("f"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   e"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1141")]),s._v("                \taddi\tsp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\te422                \tsd\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0800")]),s._v("                \taddi\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("g")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("x"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("250")]),s._v("d                \taddiw\ta0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6422")]),s._v("                \tld\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0141")]),s._v("                \taddi\tsp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8082")]),s._v("                \tret\n\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("000000000000001")]),s._v("c "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("main"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1141")]),s._v("                \taddi\tsp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\te406                \tsd\tra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\te022                \tsd\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0800")]),s._v("                \taddi\ts0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("sp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%d %d\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("f")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4635")]),s._v("                \tli\ta2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),s._v("b1                \tli\ta1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00000517")]),s._v("          \tauipc\ta0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("c"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("b050513          \taddi\ta0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("a0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1968")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("d8 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("malloc"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0xea")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00000097")]),s._v("          \tauipc\tra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600080e7")]),s._v("          \tjalr\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1536")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("630")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("printf"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4501")]),s._v("                \tli\ta0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("a"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("00000097")]),s._v("          \tauipc\tra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x0")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("e"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27e080")]),s._v("e7          \tjalr\t"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("638")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" # "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("b8 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("exit"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br")])]),t("p",[t("strong",[s._v("问题")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("问：")]),s._v(" 哪些寄存器包含函数的参数？例如，在main对printf的调用中，哪个寄存器保存了13？\n"),t("strong",[s._v("答：")]),s._v(" "),t("code",[s._v("a0-a7")]),s._v("保存函数的参数，其中"),t("code",[s._v("a0-a1")]),s._v("还可以保存返回值。在对printf的调用中，13保存在"),t("code",[s._v("a2")]),s._v("中，由汇编代码中main函数中的"),t("code",[s._v("li a2,13")]),s._v("可以看出。")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("问：")]),s._v(" main对应的汇编代码中对函数"),t("code",[s._v("f")]),s._v("的调用在哪里？ 对"),t("code",[s._v("g")]),s._v("的调用在哪里？(提示：编译器可能内联函数)\n"),t("strong",[s._v("答：")]),s._v(" 没有调用。"),t("code",[s._v("g")]),s._v("被内联到"),t("code",[s._v("f")]),s._v("中，然后"),t("code",[s._v("f")]),s._v("又被内联到main中。由汇编代码中main函数中的"),t("code",[s._v("li a1,12")]),s._v("可以看出，直接将最后的结果12传递到了"),t("code",[s._v("a1")]),s._v("。")])]),s._v(" "),t("blockquote",[t("p",[s._v("问： 函数printf位于哪个地址？\n答： 可以通过计算得到：\n----auipc ra,0x0代表将当前立即数向右移动12位，然后加上pc寄存器的值，赋给ra寄存器。由于立即数为0，因此ra的值即为pc的值0x30。\n----jalr 1536(ra)代表1536加上ra寄存器的值，然后赋值给pc。将1536转为16进制再加上0x30即为0x0000000000000630，也就是要跳转到printf的地址。")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("问：")]),s._v(" 在"),t("code",[s._v("jalr")]),s._v("到main中的printf之后，寄存器"),t("code",[s._v("ra")]),s._v("中有什么值？\n"),t("strong",[s._v("答：")]),s._v(" "),t("code",[s._v("ra")]),s._v("寄存器用来保存函数执行以后的下一条指令的地址，因此"),t("code",[s._v("ra")]),s._v("寄存器应当存放从printf返回main函数的地址，为"),t("code",[s._v("0x38")]),s._v("。")])]),s._v(" "),t("blockquote",[t("p",[s._v('问： 运行以下代码\nunsigned int i = 0x00646c72;\nprintf("H%x Wo%s", 57616, &i);\n输出是什么？\n答：\n----%x表示以十六进制形式输出整数，因此首先将57616转为16进制数，为0xe110。\n----%s表示按照字符的格式读取字符并输出，直到读取到 ‘\\0’ 为止。RISC-V是小端字节序，因此在内存中存储的形式为0x726c6400。对应的ASCII值为0x72=‘r’，0x6c=‘l’，0x64=‘d’，0x00=‘\\0’。\n----因此最后printf输出的结果为"He110, World\\0"。\n问： 能够得到上述输出是由于RISC-V是小端序的。如果 RISC-V是大端序的，要实现同样的效果，需要将i设置为什么？需要将57616修改为别的值吗？\n答： 不需要修改57616。i需要进行反转，即i=0x726c6400')])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("问：")]),s._v(" 在下面的代码中，'y='之后会打印什么？(注意：答案不是特定值)为什么会发生这种情况？\n"),t("code",[s._v('printf("x=%d y=%d", 3);')]),s._v(" "),t("strong",[s._v("答：")]),s._v(" printf需要接收2个参数，将第一个参数3放在"),t("code",[s._v("a1")]),s._v("中，第二个参数放在"),t("code",[s._v("a2")]),s._v("中。由于没有第二个参数，所有直接输出寄存器"),t("code",[s._v("a2")]),s._v("中的值。")])])])]),s._v(" "),t("h3",{attrs:{id:"二、backtrace"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、backtrace"}},[s._v("#")]),s._v(" 二、Backtrace")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("实验描述")])]),s._v(" "),t("li",[t("p",[s._v("对于调试来说，回溯通常很有用：当栈上的某一点发生错误，可以通过回溯得到上方的函数调用列表。现需要在"),t("strong",[s._v("kernel/printf.c")]),s._v("中实现"),t("code",[s._v("backtrace()")]),s._v("函数，并在系统调用"),t("code",[s._v("sys_sleep")]),s._v("中插入对该函数的调用。然后在xv6中运行"),t("code",[s._v("bttest")]),s._v("，它会调用"),t("code",[s._v("sys_sleep")]),s._v("。")])]),s._v(" "),t("li",[t("p",[s._v("思路")]),s._v(" "),t("ul",[t("li",[s._v("将"),t("code",[s._v("backtrace")]),s._v("的原型添加到"),t("strong",[s._v("kernel/defs.h")]),s._v("。")]),s._v(" "),t("li",[s._v("接着要将"),t("code",[s._v("backtrace")]),s._v("的定义添加到"),t("strong",[s._v("kernel/printf.c")]),s._v("中。由于现在才开编写该函数，只知道首先要打印一行"),t("code",[s._v("backtrace:\\n")]),s._v("。")]),s._v(" "),t("li",[s._v("xv6中用一个页来存储栈，且向低地址扩展，所以当fp到达最高地址时说明到达栈底； 返回地址位于"),t("code",[s._v("fp-8")]),s._v("处，前一个栈帧的帧指针位于"),t("code",[s._v("fp-16")]),s._v("。于是我们需要循环地打印返回地址，然后移动到前一个栈帧。")])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("backtrace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"backtrace:\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  uint64 fp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("r_fp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("PGROUNDUP")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fp"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    uint64 ra "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uint64"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("printf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%p\\n"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ra"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    fp "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uint64"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fp"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("ul",[t("li",[s._v("在"),t("strong",[s._v("kernel/printf.c")]),s._v("的"),t("code",[s._v("painc")]),s._v("中添加"),t("code",[s._v("backtrace")]),s._v("的调用。")]),s._v(" "),t("li",[s._v("在"),t("strong",[s._v("kernel/sysproc.c")]),s._v("中的系统调用"),t("code",[s._v("sys_sleep")]),s._v("里面也添加对"),t("code",[s._v("backtrace")]),s._v("的调用。")])])]),s._v(" "),t("li",[t("p",[s._v("结果")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/70db26a1ccce47d4891563c5df649db7.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/044da5a06b4b44ea980d63898dd29098.png",alt:"在这里插入图片描述"}})])])]),s._v(" "),t("h3",{attrs:{id:"三、alarm"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、alarm"}},[s._v("#")]),s._v(" 三、Alarm")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("实验要求")]),s._v(" "),t("p",[s._v("在本练习中，你将向xv6添加一个功能，该功能会在进程使用CPU时定期提醒它。这对于想要限制占用CPU时间的计算绑定进程、想要计算但又想要采取一些定期操作的进程可能很有用。更通俗地讲，你将实现一种原始形式的用户级中断/故障处理程序。例如，你可以使用类似的东西来处理应用程序中的页面错误。如果它通过了警报测试和用户测试，则你的解决方案是正确的。\n----你应该添加一个新的sigalarm(interval, handler)系统调用。如果应用程序调用sigalarm(n, fn)，那么在程序消耗每n个CPU时间“tick”之后，内核应该调用应用程序函数fn。当fn返回时，应用程序应该从中断的地方继续。在xv6中，tick是一个相当任意的时间单位，由硬件定时器产生中断的频率决定。如果应用程序调用sigalarm(0, 0)，内核应停止生成定期警报调用。\n----你将在xv6存储库中找到文件user/alarmtest.c，将其添加到Makefile。在你添加sigalarm和sigreturn系统调用之前，它不会正确编译。")])]),s._v(" "),t("li",[t("p",[s._v("test0: invoke handler 实验提示")]),s._v(" "),t("ul",[t("li",[s._v("你需要修改 Makefile 以使"),t("strong",[s._v("alarmtest.c")]),s._v("编译为xv6用户程序。")]),s._v(" "),t("li",[s._v("放入"),t("strong",[s._v("user/user.h")]),s._v("的正确声明是：")]),s._v(" "),t("li",[s._v("更新"),t("strong",[s._v("user/usys.pl")]),s._v("(生成"),t("strong",[s._v("user/usys.S")]),s._v(")、"),t("strong",[s._v("kernel/syscall.h")]),s._v("和"),t("strong",[s._v("kernel/syscall.c")]),s._v("以允许"),t("code",[s._v("alarmtest")]),s._v("调用sigalarm和sigreturn系统调用。")]),s._v(" "),t("li",[s._v("现在，你的"),t("code",[s._v("sys_sigreturn")]),s._v("应该只返回0。")]),s._v(" "),t("li",[s._v("你的"),t("code",[s._v("sys_sigalarm()")]),s._v("应该将警报间隔和指向处理函数的指针存储在"),t("code",[s._v("proc")]),s._v("结构(在"),t("strong",[s._v("kernel/proc.h")]),s._v("中)的新字段中。")]),s._v(" "),t("li",[s._v("你需要跟踪自上次调用进程的警报处理程序以来已经过去了多少tick。为此，你还需要在"),t("code",[s._v("struct proc")]),s._v("中新加一个字段。你可以在"),t("strong",[s._v("proc.c")]),s._v("中的"),t("code",[s._v("allocproc()")]),s._v("中初始化"),t("code",[s._v("proc")]),s._v("的各字段。")]),s._v(" "),t("li",[s._v("对于每个tick，硬件时钟都会强制中断，该中断在"),t("strong",[s._v("kernel/trap.c")]),s._v("中的"),t("code",[s._v("usertrap()")]),s._v("中处理。")]),s._v(" "),t("li",[s._v("如果有计时器中断，但你只想操纵进程的警报tick，你需要以下代码")]),s._v(" "),t("li",[s._v("仅当进程有未完成的计时器时才调用警报函数。请注意，用户的警报函数的地址可能为0(例如，在"),t("strong",[s._v("user/alarmtest.asm")]),s._v("中，"),t("code",[s._v("periodic")]),s._v("在地址0处)。")]),s._v(" "),t("li",[s._v("你需要修改"),t("code",[s._v("usertrap()")]),s._v("以便在进程的警报间隔到期时，用户进程执行处理函数。当RISC-V上的trap返回到用户空间时，是什么决定了用户空间代码恢复执行的指令地址？")]),s._v(" "),t("li",[s._v("如果你告诉qemu只使用一个CPU，那么使用gdb查看trap会更容易。你可以通过运行下面指令实现。")]),s._v(" "),t("li",[s._v("如果alarmtest打印出“alarm!”，你就成功了。")])])]),s._v(" "),t("li",[t("p",[s._v("思路")]),s._v(" "),t("ul",[t("li",[s._v("在Makefile的"),t("code",[s._v("UPROGS")]),s._v("中添加"),t("code",[s._v("$U/_alarmtest\\")])]),s._v(" "),t("li",[s._v("在"),t("strong",[s._v("user/user.h")]),s._v("中放入"),t("code",[s._v("sigalarm")]),s._v("和"),t("code",[s._v("sigreturn")]),s._v("的声明。")]),s._v(" "),t("li",[s._v("更新"),t("strong",[s._v("user/usys.pl")]),s._v("(生成"),t("strong",[s._v("user/usys.S")]),s._v(")。")]),s._v(" "),t("li",[s._v("更新"),t("strong",[s._v("kernel/syscall.h")]),s._v(" ,更新 "),t("strong",[s._v("kernel/syscall.c")])]),s._v(" "),t("li",[s._v("在"),t("strong",[s._v("kernel/sysproc.c")]),s._v("中编写"),t("code",[s._v("sys_sigreturn")]),s._v("，返回0。")]),s._v(" "),t("li",[s._v("将警报间隔和指向警报处理函数的指针存储在"),t("code",[s._v("proc")]),s._v("结构中。")])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// alarm interval time")]),s._v("\nuint64 handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// alarm handle function")]),s._v("\nuint64 ticks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// how many ticks have passed since the last call")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("在"),t("strong",[s._v("kernel/proc.c")]),s._v("中的"),t("code",[s._v("allocproc()")]),s._v("中初始化"),t("code",[s._v("proc")]),s._v("字段。")])]),s._v(" "),t("li",[t("p",[s._v("如果有时钟中断，我们操作进程的警报tick，因此在"),t("code",[s._v("if (which_dev==2)")]),s._v("情况下进行处理; 如果tick没到达设定的间隔，则将tick++;如果tick达到设定的间隔，则将tick清零，同时转去相应的处理程序handler。此处主要考虑如何调用处理函数handler。在usertrap中页表已经切换为内核页表，而handler仍然是用户页表的函数虚拟地址，因此不能直接调用。这里我们将p->trapfram->epc置为p->handler，这样在返回到用户空间时，程序计数器为handler定时函数的地址，便达到了执行定时函数的目的。(这里做的其实就是在内核态进行赋值，返回到用户态再执行。)")]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("which_dev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("epc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("yield")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("最后，我们还需要来完成"),t("code",[s._v("sys_sigalarm")]),s._v("函数的定义。该函数主要完成对proc结构体中与警报程序相关的成员变量进行赋值。")])])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[s._v("uint64 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sys_sigalarm")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  uint64 handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("proc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// sigalarm的第一个参数为ticks，第二个参数为void(*handler)()")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("argint")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("argaddr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" interval "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("myproc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("interval "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("handler "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("结果")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/cbada879a174453c8fc8a0dd6b058ba9.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("ul",[t("li",[s._v("test1/test2(): resume interrupted code")]),s._v(" "),t("li",[s._v("实验描述")])]),s._v(" "),t("blockquote",[t("p",[s._v("----有可能alarmtest在打印“alarm!”后在test0或test1中崩溃，或者alarmtest打印“test1 failed”，或者alarmtest退出而不打印“test1 pass”。\n----要解决此问题，你必须确保在警报处理程序完成后，控制权返回到用户程序最初被定时器中断所中断的指令。\n----你还必须确保寄存器内容恢复到它们在中断时保持的值，以便用户程序可以在警报后不受干扰地继续运行。\n----最后，你应该在每次关闭后清零警报计数器，以便定期调用处理程序。\n----我们已经为设计了一种解决方案：用户警报处理程序需要在完成后调用sigreturn系统调用。如alarmtest.c中的periodic。这意味着你可以将代码添加到usertrap和sys_sigreturn中，它们会协同工作以使用户进程在处理完警报后正确恢复。")])]),s._v(" "),t("ul",[t("li",[t("p",[s._v("提示：")]),s._v(" "),t("ul",[t("li",[s._v("您的解决方案将要求你保存和恢复寄存器----你需要保存和恢复哪些寄存器才能正确恢复中断的代码？(提示：会很多)")]),s._v(" "),t("li",[s._v("当计时器关闭时，让"),t("code",[s._v("usertrap")]),s._v("在"),t("code",[s._v("struct proc")]),s._v("中保存足够的状态，以便"),t("code",[s._v("sigreturn")]),s._v("可以正确返回到被中断的用户代码。")]),s._v(" "),t("li",[s._v("防止对警报处理程序的重入调用----如果处理程序尚未返回，内核不应再次调用它。 test2对此会进行测试。")]),s._v(" "),t("li",[s._v("一旦你通过了test0、test1和test2，运行usertests以确保你没有破坏内核的任何其他部分。")])])]),s._v(" "),t("li",[t("p",[s._v("思路")]),s._v(" "),t("ul",[t("li",[s._v("在proc结构体中添加一个指向trapframe副本的指针。")])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("proc")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// alarm interval time")]),s._v("\n\tuint64 handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// alarm handle function")]),s._v("\n\tuint64 ticks"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                 "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// how many ticks have passed since the last call")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("trapframe")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" trapframecopy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//添加")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ul",[t("li",[s._v("在"),t("strong",[s._v("kernel/trap.c")]),s._v("的"),t("code",[s._v("usertrap")]),s._v("中覆盖"),t("code",[s._v("p->trapframe->epc")]),s._v("将trapframe的副本进行保存。同时，将之前调用"),t("code",[s._v("handler")]),s._v("后执行的"),t("code",[s._v("ticks=0")]),s._v("删除，以实现防止"),t("code",[s._v("handler")]),s._v("重入。")])]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// give up the CPU if this is a timer interrupt.")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("which_dev "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("interval"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframecopy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  \n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("memmove")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframecopy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("trapframe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 复制trapframe")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("epc "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uint64"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("handler"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("ul",[t("li",[t("p",[s._v("在sys_sigreturn中将trapframecopy拷贝到原trapframe中。恢复后将trapframecopy置零，表示当前没有副本。同时在拷贝trapframecopy前做了一个地址判断，是为了防止用户程序未调用sigalarm便使用了该系统调用。此时没有trapframecopy是无效的，可以避免错误拷贝")]),s._v(" "),t("div",{staticClass:"language-cpp line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-cpp"}},[t("code",[s._v("uint64 "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sys_sigreturn")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("proc")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" p "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("myproc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// trapframecopy must have the copy of trapframe")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframecopy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("512")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("memmove")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframecopy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("sizeof")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("trapframe")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// restore the trapframe")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("ticks "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// prevent re-entrant")]),s._v("\n    p"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("trapframecopy "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 置零")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])])])])]),s._v(" "),t("li",[t("p",[s._v("结果")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/0eb0aa7a1bc84c3db096a793aaef5063.png",alt:"在这里插入图片描述"}})]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/364bffb50a7e48f59ddddab0ecb59744.png",alt:"在这里插入图片描述"}})])])}),[],!1,null,null,null);t.default=r.exports}}]);