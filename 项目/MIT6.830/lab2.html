<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MIT数据库Lab2实验报告 | 清溪的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/VuePressBlog/logo.png">
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/VuePressBlog/js/MouseClickEffect.js"></script>
    <meta name="description" content="面向对象面向君，不负代码不负卿。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="QingXi,博客,conimi,nico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/VuePressBlog/assets/css/0.styles.9c388079.css" as="style"><link rel="preload" href="/VuePressBlog/assets/js/app.f42cc359.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/3.baa1ae3e.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/1.17eb7108.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/295.57924749.js" as="script"><link rel="prefetch" href="/VuePressBlog/assets/js/10.5cde4a25.js"><link rel="prefetch" href="/VuePressBlog/assets/js/100.e8835302.js"><link rel="prefetch" href="/VuePressBlog/assets/js/101.4813f7c4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/102.f2d0070e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/103.d51d5e7b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/104.2c2e0a97.js"><link rel="prefetch" href="/VuePressBlog/assets/js/105.81d767bd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/106.84bc095e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/107.d38a913b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/108.fdd75af5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/109.6c8c1b80.js"><link rel="prefetch" href="/VuePressBlog/assets/js/11.9aa5edfb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/110.e3a005f8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/111.55e98135.js"><link rel="prefetch" href="/VuePressBlog/assets/js/112.72f7c7a6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/113.b4e28c57.js"><link rel="prefetch" href="/VuePressBlog/assets/js/114.cf2181a8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/115.1e83aaa0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/116.e10e2ee4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/117.b52ba16c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/118.d020bf92.js"><link rel="prefetch" href="/VuePressBlog/assets/js/119.08f665e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/12.60bc0f16.js"><link rel="prefetch" href="/VuePressBlog/assets/js/120.d01dd2b3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/121.31ea9879.js"><link rel="prefetch" href="/VuePressBlog/assets/js/122.84d94594.js"><link rel="prefetch" href="/VuePressBlog/assets/js/123.53a4b3d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/124.34960a24.js"><link rel="prefetch" href="/VuePressBlog/assets/js/125.b10668d4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/126.4727128f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/127.bd0444ac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/128.f13fb966.js"><link rel="prefetch" href="/VuePressBlog/assets/js/129.cd58c794.js"><link rel="prefetch" href="/VuePressBlog/assets/js/13.d19e71e7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/130.cb81ade2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/131.224e10c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/132.8e9935c7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/133.efb1e341.js"><link rel="prefetch" href="/VuePressBlog/assets/js/134.f0ae3784.js"><link rel="prefetch" href="/VuePressBlog/assets/js/135.ede58465.js"><link rel="prefetch" href="/VuePressBlog/assets/js/136.b61d3341.js"><link rel="prefetch" href="/VuePressBlog/assets/js/137.cec28cb5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/138.7a03caed.js"><link rel="prefetch" href="/VuePressBlog/assets/js/139.1e11c602.js"><link rel="prefetch" href="/VuePressBlog/assets/js/14.add2b9d1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/140.13501399.js"><link rel="prefetch" href="/VuePressBlog/assets/js/141.855e01a3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/142.d167685b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/143.e4099358.js"><link rel="prefetch" href="/VuePressBlog/assets/js/144.01aa96d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/145.0d7704dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/146.15a0c678.js"><link rel="prefetch" href="/VuePressBlog/assets/js/147.e4106bdb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/148.752aea80.js"><link rel="prefetch" href="/VuePressBlog/assets/js/149.63cc4679.js"><link rel="prefetch" href="/VuePressBlog/assets/js/15.a7aa72c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/150.a888b9db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/151.699fc7f2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/152.4e0a1d97.js"><link rel="prefetch" href="/VuePressBlog/assets/js/153.c06c2807.js"><link rel="prefetch" href="/VuePressBlog/assets/js/154.b5c8588a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/155.77e5eb1b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/156.113c82e4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/157.63bacdc9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/158.3f51e3c8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/159.4c3ab201.js"><link rel="prefetch" href="/VuePressBlog/assets/js/16.f8623d4d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/160.0643eed1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/161.aabff61f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/162.1683bd2a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/163.9dee0aec.js"><link rel="prefetch" href="/VuePressBlog/assets/js/164.eb5ed749.js"><link rel="prefetch" href="/VuePressBlog/assets/js/165.897998ac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/166.2ee105e0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/167.d7740ae3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/168.8f68baf6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/169.fe9fa913.js"><link rel="prefetch" href="/VuePressBlog/assets/js/17.610ee079.js"><link rel="prefetch" href="/VuePressBlog/assets/js/170.a8520244.js"><link rel="prefetch" href="/VuePressBlog/assets/js/171.21b14c12.js"><link rel="prefetch" href="/VuePressBlog/assets/js/172.10f99edd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/173.d7656598.js"><link rel="prefetch" href="/VuePressBlog/assets/js/174.7b9982df.js"><link rel="prefetch" href="/VuePressBlog/assets/js/175.99b01236.js"><link rel="prefetch" href="/VuePressBlog/assets/js/176.8ffef3ae.js"><link rel="prefetch" href="/VuePressBlog/assets/js/177.8b5872f1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/178.f8fc68ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/179.74a0b348.js"><link rel="prefetch" href="/VuePressBlog/assets/js/18.2e373db1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/180.81daf4e2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/181.01a6ef36.js"><link rel="prefetch" href="/VuePressBlog/assets/js/182.774dc5db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/183.d6ef8913.js"><link rel="prefetch" href="/VuePressBlog/assets/js/184.00862cd9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/185.b6894feb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/186.d1708cfc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/187.78b12cd6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/188.435b5abb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/189.c6ba7871.js"><link rel="prefetch" href="/VuePressBlog/assets/js/19.a9cebc54.js"><link rel="prefetch" href="/VuePressBlog/assets/js/190.2313d5c9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/191.7cbf852a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/192.cddbe224.js"><link rel="prefetch" href="/VuePressBlog/assets/js/193.77be9e07.js"><link rel="prefetch" href="/VuePressBlog/assets/js/194.9faf5142.js"><link rel="prefetch" href="/VuePressBlog/assets/js/195.6cadeeff.js"><link rel="prefetch" href="/VuePressBlog/assets/js/196.18a6b13c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/197.d5c76246.js"><link rel="prefetch" href="/VuePressBlog/assets/js/198.ba71e4cc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/199.8657a621.js"><link rel="prefetch" href="/VuePressBlog/assets/js/20.0f9cbebc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/200.3f21b610.js"><link rel="prefetch" href="/VuePressBlog/assets/js/201.2f13f56b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/202.1f2c89fd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/203.2595c2c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/204.a8191c75.js"><link rel="prefetch" href="/VuePressBlog/assets/js/205.5f3c94db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/206.2f8f2eab.js"><link rel="prefetch" href="/VuePressBlog/assets/js/207.bd13d97d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/208.8bf6932c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/209.ff286b0e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/21.c601bb2b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/210.f872f5b1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/211.cfe52e6b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/212.01e4bed2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/213.7871b223.js"><link rel="prefetch" href="/VuePressBlog/assets/js/214.0dbb3d93.js"><link rel="prefetch" href="/VuePressBlog/assets/js/215.f8499355.js"><link rel="prefetch" href="/VuePressBlog/assets/js/216.d5b75f04.js"><link rel="prefetch" href="/VuePressBlog/assets/js/217.bc9be9db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/218.0a3d8a08.js"><link rel="prefetch" href="/VuePressBlog/assets/js/219.b90a5880.js"><link rel="prefetch" href="/VuePressBlog/assets/js/22.715a7176.js"><link rel="prefetch" href="/VuePressBlog/assets/js/220.538aadfa.js"><link rel="prefetch" href="/VuePressBlog/assets/js/221.8b556650.js"><link rel="prefetch" href="/VuePressBlog/assets/js/222.6ca7436f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/223.ee04d6bc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/224.c64cacac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/225.6e3d044b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/226.13d32a7f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/227.b49aa5d2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/228.26422d49.js"><link rel="prefetch" href="/VuePressBlog/assets/js/229.3f590304.js"><link rel="prefetch" href="/VuePressBlog/assets/js/23.0df333c9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/230.b5f05cc3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/231.a123ac7b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/232.045132c3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/233.a38327cc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/234.3ff57bc3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/235.827c2ad3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/236.bd5703d9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/237.c890a564.js"><link rel="prefetch" href="/VuePressBlog/assets/js/238.c4f28694.js"><link rel="prefetch" href="/VuePressBlog/assets/js/239.2bbfd7e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/24.039ee5f1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/240.84333a0d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/241.f9d6be5a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/242.b2fbffbe.js"><link rel="prefetch" href="/VuePressBlog/assets/js/243.4fee254c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/244.9a62ae23.js"><link rel="prefetch" href="/VuePressBlog/assets/js/245.b90c2426.js"><link rel="prefetch" href="/VuePressBlog/assets/js/246.5744a2d4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/247.5458c9bf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/248.d58a7106.js"><link rel="prefetch" href="/VuePressBlog/assets/js/249.ea10a59c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/25.0c24181f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/250.bb60e3c5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/251.3fa1c079.js"><link rel="prefetch" href="/VuePressBlog/assets/js/252.3c4921b2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/253.2fb57abe.js"><link rel="prefetch" href="/VuePressBlog/assets/js/254.4d32714a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/255.1701e9c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/256.de4f48cf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/257.e3179f76.js"><link rel="prefetch" href="/VuePressBlog/assets/js/258.f2eed53d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/259.6b76ae85.js"><link rel="prefetch" href="/VuePressBlog/assets/js/26.6a162497.js"><link rel="prefetch" href="/VuePressBlog/assets/js/260.d280a827.js"><link rel="prefetch" href="/VuePressBlog/assets/js/261.3c5a0923.js"><link rel="prefetch" href="/VuePressBlog/assets/js/262.567dd288.js"><link rel="prefetch" href="/VuePressBlog/assets/js/263.9e44df73.js"><link rel="prefetch" href="/VuePressBlog/assets/js/264.a0956551.js"><link rel="prefetch" href="/VuePressBlog/assets/js/265.b718532c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/266.706cb10b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/267.3e34d2c7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/268.208628c4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/269.5a05a7c1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/27.671023ee.js"><link rel="prefetch" href="/VuePressBlog/assets/js/270.5598a9ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/271.6e93da05.js"><link rel="prefetch" href="/VuePressBlog/assets/js/272.90e59ecb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/273.38adede7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/274.b1e5e4b5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/275.abe0b794.js"><link rel="prefetch" href="/VuePressBlog/assets/js/276.eeb46ffd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/277.25d075be.js"><link rel="prefetch" href="/VuePressBlog/assets/js/278.44d14db9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/279.78bf4c9c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/28.037ed440.js"><link rel="prefetch" href="/VuePressBlog/assets/js/280.1922e347.js"><link rel="prefetch" href="/VuePressBlog/assets/js/281.9ec656d8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/282.3e712165.js"><link rel="prefetch" href="/VuePressBlog/assets/js/283.022a227c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/284.2f332785.js"><link rel="prefetch" href="/VuePressBlog/assets/js/285.438e22f5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/286.51955bfa.js"><link rel="prefetch" href="/VuePressBlog/assets/js/287.b4085831.js"><link rel="prefetch" href="/VuePressBlog/assets/js/288.5a2658cb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/289.058dc59b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/29.e52a9d90.js"><link rel="prefetch" href="/VuePressBlog/assets/js/290.eff2d159.js"><link rel="prefetch" href="/VuePressBlog/assets/js/291.ad38ea49.js"><link rel="prefetch" href="/VuePressBlog/assets/js/292.19cfeb16.js"><link rel="prefetch" href="/VuePressBlog/assets/js/293.6feeacae.js"><link rel="prefetch" href="/VuePressBlog/assets/js/294.d9533826.js"><link rel="prefetch" href="/VuePressBlog/assets/js/296.3422295d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/297.b2ec8551.js"><link rel="prefetch" href="/VuePressBlog/assets/js/298.99dd412a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/299.27c9cfcf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/30.9d5b3ef4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/300.144b0c04.js"><link rel="prefetch" href="/VuePressBlog/assets/js/301.3071d48c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/302.651526dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/303.b350ada5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/304.68aa14e6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/305.533e903e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/306.43d3a3cd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/307.dd003bbc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/308.a9600cd4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/309.98357284.js"><link rel="prefetch" href="/VuePressBlog/assets/js/31.1cc30d4f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/310.af64ad9c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/311.aee170c5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/312.9a00d6c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/32.460d68ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/33.80f2039a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/34.f573e1fb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/35.fc195065.js"><link rel="prefetch" href="/VuePressBlog/assets/js/36.03edaa74.js"><link rel="prefetch" href="/VuePressBlog/assets/js/37.6170733e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/38.4e800202.js"><link rel="prefetch" href="/VuePressBlog/assets/js/39.08c0ec17.js"><link rel="prefetch" href="/VuePressBlog/assets/js/4.10543b34.js"><link rel="prefetch" href="/VuePressBlog/assets/js/40.f6d02ad2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/41.6b527226.js"><link rel="prefetch" href="/VuePressBlog/assets/js/42.b6db7c15.js"><link rel="prefetch" href="/VuePressBlog/assets/js/43.1c8dc528.js"><link rel="prefetch" href="/VuePressBlog/assets/js/44.3feac64e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/45.72f2dd5e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/46.1b3b5f62.js"><link rel="prefetch" href="/VuePressBlog/assets/js/47.3e894961.js"><link rel="prefetch" href="/VuePressBlog/assets/js/48.acca312d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/49.fc79094c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/5.d0f450bd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/50.4d8f01e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/51.c36c9269.js"><link rel="prefetch" href="/VuePressBlog/assets/js/52.2d3bf96c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/53.002fa1bb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/54.5ba094ff.js"><link rel="prefetch" href="/VuePressBlog/assets/js/55.ee846bd2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/56.d29d1bad.js"><link rel="prefetch" href="/VuePressBlog/assets/js/57.2fd125e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/58.a0f9d4e9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/59.4bddbee6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/6.24060e60.js"><link rel="prefetch" href="/VuePressBlog/assets/js/60.7bd2fd4c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/61.d1ba9295.js"><link rel="prefetch" href="/VuePressBlog/assets/js/62.77818eb4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/63.37359d58.js"><link rel="prefetch" href="/VuePressBlog/assets/js/64.9419cd75.js"><link rel="prefetch" href="/VuePressBlog/assets/js/65.ef2a03a2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/66.ec148097.js"><link rel="prefetch" href="/VuePressBlog/assets/js/67.70adf0f4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/68.9edae7ec.js"><link rel="prefetch" href="/VuePressBlog/assets/js/69.a282d9f8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/7.b8bf6b3f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/70.9da04b45.js"><link rel="prefetch" href="/VuePressBlog/assets/js/71.e66347dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/72.35386d60.js"><link rel="prefetch" href="/VuePressBlog/assets/js/73.3ae48352.js"><link rel="prefetch" href="/VuePressBlog/assets/js/74.aa533041.js"><link rel="prefetch" href="/VuePressBlog/assets/js/75.c365f351.js"><link rel="prefetch" href="/VuePressBlog/assets/js/76.e3fa8430.js"><link rel="prefetch" href="/VuePressBlog/assets/js/77.709bb6a4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/78.aa043416.js"><link rel="prefetch" href="/VuePressBlog/assets/js/79.ac9ff67d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/8.024a3703.js"><link rel="prefetch" href="/VuePressBlog/assets/js/80.aeb25e4e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/81.c83cd55c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/82.7d6d1162.js"><link rel="prefetch" href="/VuePressBlog/assets/js/83.da5d7007.js"><link rel="prefetch" href="/VuePressBlog/assets/js/84.45020071.js"><link rel="prefetch" href="/VuePressBlog/assets/js/85.d00e8c23.js"><link rel="prefetch" href="/VuePressBlog/assets/js/86.34b47188.js"><link rel="prefetch" href="/VuePressBlog/assets/js/87.8b6d49ab.js"><link rel="prefetch" href="/VuePressBlog/assets/js/88.278b18a6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/89.99e94d6e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/9.d630a5e2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/90.f0f914d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/91.ee4fa553.js"><link rel="prefetch" href="/VuePressBlog/assets/js/92.b7f22909.js"><link rel="prefetch" href="/VuePressBlog/assets/js/93.c74fb8c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/94.e9d25630.js"><link rel="prefetch" href="/VuePressBlog/assets/js/95.bf8f1e37.js"><link rel="prefetch" href="/VuePressBlog/assets/js/96.9ccbbd24.js"><link rel="prefetch" href="/VuePressBlog/assets/js/97.73707f37.js"><link rel="prefetch" href="/VuePressBlog/assets/js/98.ce525fd0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/99.c45e5fab.js">
    <link rel="stylesheet" href="/VuePressBlog/assets/css/0.styles.9c388079.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-11f94078><div data-v-11f94078><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-11f94078 data-v-11f94078><h3 class="title" data-v-08f61db9>清溪的博客</h3> <p class="description" data-v-08f61db9>面向对象面向君，不负代码不负卿。</p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>QingXi</span>
          
        <span data-v-08f61db9>2022 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-11f94078><header class="navbar" data-v-11f94078><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/VuePressBlog/" class="home-link router-link-active"><img src="/VuePressBlog/logo.png" alt="清溪的博客" class="logo"> <span class="site-name">清溪的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/VuePressBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/VuePressBlog/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/VuePressBlog/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-11f94078></div> <aside class="sidebar" data-v-11f94078><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-11f94078><img src="/VuePressBlog/logo.png" alt="author-avatar" class="personal-img" data-v-3d87d2e4> <h3 class="name" data-v-3d87d2e4>
    QingXi
  </h3> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>74</h3> <h6 data-v-3d87d2e4>文章</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>29</h3> <h6 data-v-3d87d2e4>标签</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/VuePressBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/VuePressBlog/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/VuePressBlog/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MIT项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MIT数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/VuePressBlog/项目/MIT6.830/lab1.html" class="sidebar-link">MIT数据库Lab1实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab2.html" class="active sidebar-link">MIT数据库Lab2实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab3.html" class="sidebar-link">MIT数据库Lab3实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab4.html" class="sidebar-link">MIT数据库Lab4实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab5.html" class="sidebar-link">MIT数据库Lab5实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab6.html" class="sidebar-link">MIT数据库Lab6实验报告</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>游戏项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>精准问答系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-11f94078><h3 class="title" data-v-08f61db9>MIT数据库Lab2实验报告</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>QingXi</span>
          
        <span data-v-08f61db9>2022 - </span>
        2023
      </a></span></div></div> <div data-v-11f94078><div data-v-11f94078><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">MIT数据库Lab2实验报告</h1> <div data-v-162cc157><i class="iconfont reco-account" data-v-162cc157><span data-v-162cc157>QingXi</span></i> <!----> <i class="iconfont reco-eye" data-v-162cc157><span id="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-162cc157><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><p><strong>课程源码(包含各Lab讲义)</strong>：<a href="https://github.com/MIT-DB-Class/simple-db-hw-2021" target="_blank" rel="noopener noreferrer">MIT-DB-Class/simple-db-hw-2021 (github.com)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>课程内容非mit学生只能查看PDF以及PPT，如果熟悉数据库的基本概念可以不看这些文档，只实现lab即可；如果想深入了解数据库的基本概念，可以参考一下b站课程cs15-445，个人感觉这门课程讲的很不错，基本能符合6.830的各个实验阶段所需要的知识</p></blockquote> <h2 id="_1、开始"><a href="#_1、开始" class="header-anchor">#</a> 1、开始</h2> <p>lab2必须在lab1提交的代码基础上进行开发，否则无法完成相应的练习。此外，实验还提供了源码中不存在的额外测试文件。</p> <h3 id="_1-1实现提示"><a href="#_1-1实现提示" class="header-anchor">#</a> 1.1实现提示</h3> <p>开始编写代码之前，强烈建议通读整篇文档，以对SimpleDB的设计有个整体的认识，对于我们编写代码非常有帮助</p> <p>建议跟着文档的练习来实现对应的代码，每个练习都标明了要实现哪个类以及通过哪些单元测试，跟着练习走即可。</p> <p>下面是本实验的大致流程：</p> <ul><li>实现Filter和Join操作并且通过相关的单元测试验证你的实现，阅读类的Javadoc将会帮助我们实现。项目中已经提供了Project和OrderBy操作的实现，阅读其代码能够帮助我们理解其他操作是如何实现的</li> <li>实现IntegerAggregator和StringAggregator，你将会编写对元组的某一特定列分组进行聚合操作；其中integer支持求和、求最大最小值、求数量、求平均值，string只支持count聚合操作</li> <li>实现Aggregate操作；同其他操作一样，聚合操作也实现类OpIterator接口。注意每次调用next()的Aggregate操作的输出是整个分组的聚合值，Aggregate构造函数将会设置聚合和分组操作对应的列</li> <li>实现BufferPool类中的插入、删除和页面丢弃策略，暂时不需要关心事务</li> <li>实现Insert和Delete操作；与所有的操作相似，Insert和Delete实现OpIterator接口，接收用于插入或者删除的元组并输出该操作影响的元组个数；这些操作将会调用BufferPool中合适的方法用于修改磁盘上的页</li></ul> <p>注意SimpleDB没有实现一致性和完整性检查，所以它可能会插入重复的记录，并且没有方法保证主键或外键的一致性</p> <p>在本节实现的基础上，我们需要使用项目提供的SQL解析器去运行SQL语句查询</p> <p>最后，你可能会发现本实验的操作扩展Operator类而不是实现OpIterator接口。因为next/hasNext的实现总是重复的、烦人的，Operator实现了通用的逻辑操作，并且仅需要实现readNext方法。可以随意使用这种风格，或者使用OpIterator。如果要实现OpIterator接口，请移除extends Operator，并替换为implements OpIterator.</p> <h2 id="_2、实验指导"><a href="#_2、实验指导" class="header-anchor">#</a> 2、实验指导</h2> <h3 id="_2-1-filter-and-join"><a href="#_2-1-filter-and-join" class="header-anchor">#</a> 2.1 Filter and Join</h3> <p>本节将会实现比扫描整张表更有趣的操作：</p> <ul><li>Filter：该操作仅返回满足(构造时指定的)Predicate操作的元组；因此，它会过滤那些不符合操作的元组</li> <li>Join：该操作将会通过(构造时指定的)JoinPredicate联合两个表的元组，Join操作仅需实现一个简单的嵌套循环连接</li></ul> <p><strong>练习1</strong></p> <p>实现如下类中的方法：</p> <ul><li>src/java/simpledb/execution/Predicate.java</li> <li>src/java/simpledb/execution/JoinPredicate.java</li> <li>src/java/simpledb/execution/Filter.java</li> <li>src/java/simpledb/execution/Join.java</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Predicate compares tuples to a specified Field value.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Predicate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Op</span> op<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Field</span> operand<span class="token punctuation">;</span>

    <span class="token comment">/** Constants used for return codes in Field.compare */</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Op</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
        <span class="token constant">EQUALS</span><span class="token punctuation">,</span> <span class="token constant">GREATER_THAN</span><span class="token punctuation">,</span> <span class="token constant">LESS_THAN</span><span class="token punctuation">,</span> <span class="token constant">LESS_THAN_OR_EQ</span><span class="token punctuation">,</span> <span class="token constant">GREATER_THAN_OR_EQ</span><span class="token punctuation">,</span> <span class="token constant">LIKE</span><span class="token punctuation">,</span> <span class="token constant">NOT_EQUALS</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * Interface to access operations by integer value for command-line
         * convenience.
         * 
         * @param i
         *            a valid integer Op index
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Op</span> <span class="token function">getOp</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">EQUALS</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">GREATER_THAN</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&gt;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">LESS_THAN</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&lt;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">LESS_THAN_OR_EQ</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&lt;=&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">GREATER_THAN_OR_EQ</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&gt;=&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">LIKE</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;LIKE&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> <span class="token constant">NOT_EQUALS</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string">&quot;&lt;&gt;&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;impossible to reach here&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Constructor.
     * 
     * @param field
     *            field number of passed in tuples to compare against.
     * @param op
     *            operation to use for comparison
     * @param operand
     *            field value to compare passed in tuples to
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token punctuation">(</span><span class="token keyword">int</span> field<span class="token punctuation">,</span> <span class="token class-name">Op</span> op<span class="token punctuation">,</span> <span class="token class-name">Field</span> operand<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field <span class="token operator">=</span> field<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>op <span class="token operator">=</span> op<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>operand <span class="token operator">=</span> operand<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the field number
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Op</span> <span class="token function">getOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @return the operand
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Field</span> <span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> operand<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * Compares the field number of t specified in the constructor to the
     * operand field specified in the constructor using the operator specific in
     * the constructor. The comparison can be made through Field's compare
     * method.
     * 
     * @param t
     *            The tuple to compare against
     * @return true if the comparison is true, false otherwise.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> operand<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns something useful, like &quot;f = field_id op = op_string operand =
     * operand_string&quot;
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token string">&quot;f = &quot;</span> <span class="token operator">+</span> field <span class="token operator">+</span> <span class="token string">&quot; op = &quot;</span> <span class="token operator">+</span> op<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; operand = &quot;</span> <span class="token operator">+</span> operand<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * JoinPredicate compares fields of two tuples using a predicate. JoinPredicate
 * is most likely used by the Join operator.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JoinPredicate</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> field2<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor -- create a new predicate over two fields of two tuples.
     * 
     * @param field1
     *            The field index into the first tuple in the predicate
     * @param field2
     *            The field index into the second tuple in the predicate
     * @param op
     *            The operation to apply (as defined in Predicate.Op); either
     *            Predicate.Op.GREATER_THAN, Predicate.Op.LESS_THAN,
     *            Predicate.Op.EQUAL, Predicate.Op.GREATER_THAN_OR_EQ, or
     *            Predicate.Op.LESS_THAN_OR_EQ
     * @see Predicate
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">JoinPredicate</span><span class="token punctuation">(</span><span class="token keyword">int</span> field1<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> field2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field1 <span class="token operator">=</span> field1<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>field2 <span class="token operator">=</span> field2<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>op <span class="token operator">=</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Apply the predicate to the two specified tuples. The comparison can be
     * made through Field's compare method.
     * 
     * @return true if the tuples satisfy the predicate.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t1<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> t1<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span>t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>field2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getField2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> field2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> <span class="token function">getOperator</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> op<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Filter is an operator that implements a relational select.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Filter</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Predicate</span> p<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor accepts a predicate to apply and a child operator to read
     * tuples to filter from.
     * 
     * @param p
     *            The predicate to filter tuples with
     * @param child
     *            The child operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Filter</span><span class="token punctuation">(</span><span class="token class-name">Predicate</span> p<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Predicate</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * AbstractDbIterator.readNext implementation. Iterates over tuples from the
     * child operator, applying the predicate to them and returning those that
     * pass the predicate (i.e. for which the Predicate.filter() returns true.)
     * 
     * @return The next tuple that passes the filter, or null if there are no
     *         more tuples
     * @see Predicate#filter
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> tuple<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The Join operator implements the relational join operation.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Join</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">JoinPredicate</span> joinPredicate<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child1<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child2<span class="token punctuation">;</span>
    <span class="token comment">//临时元组，保存上次迭代用的child1的Tuple</span>
    <span class="token keyword">private</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor. Accepts two children to join and the predicate to join them
     * on
     * 
     * @param p
     *            The predicate to use to join the children
     * @param child1
     *            Iterator for the left(outer) relation to join
     * @param child2
     *            Iterator for the right(inner) relation to join
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Join</span><span class="token punctuation">(</span><span class="token class-name">JoinPredicate</span> p<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child1<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>joinPredicate <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child1 <span class="token operator">=</span> child1<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child2 <span class="token operator">=</span> child2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">JoinPredicate</span> <span class="token function">getJoinPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> joinPredicate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *       the field name of join field1. Should be quantified by
     *       alias or table name.
     * */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJoinField1Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child1<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>joinPredicate<span class="token punctuation">.</span><span class="token function">getField1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return
     *       the field name of join field2. Should be quantified by
     *       alias or table name.
     * */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getJoinField2Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>joinPredicate<span class="token punctuation">.</span><span class="token function">getField2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @see TupleDesc#merge(TupleDesc, TupleDesc) for possible
     *      implementation logic.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> child2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child1<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child1<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child1<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the next tuple generated by the join, or null if there are no
     * more tuples. Logically, this is the next tuple in r1 cross r2 that
     * satisfies the join predicate. There are many possible implementations;
     * the simplest is a nested loops join.
     * &lt;p&gt;
     * Note that the tuples returned from this particular implementation of Join
     * are simply the concatenation of joining tuples from the left and right
     * relation. Therefore, if an equality predicate is used there will be two
     * copies of the join attribute in the results. (Removing such duplicate
     * columns can be done with an additional projection operator if needed.)
     * &lt;p&gt;
     * For example, if one tuple is {1,2,3} and the other tuple is {1,5,6},
     * joined on equality of the first column, then this returns {1,2,3,1,5,6}.
     * 
     * @return The next matching tuple.
     * @see JoinPredicate#filter
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//t可能是笛卡尔积</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>child1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                t <span class="token operator">=</span> child1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>child2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Tuple</span> t2 <span class="token operator">=</span> child2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>joinPredicate<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> t2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">TupleDesc</span> td1 <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TupleDesc</span> td2 <span class="token operator">=</span> t2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//合并</span>
                    <span class="token class-name">TupleDesc</span> tupleDesc <span class="token operator">=</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">.</span><span class="token function">merge</span><span class="token punctuation">(</span>td1<span class="token punctuation">,</span> td2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//创建新的行</span>
                    <span class="token class-name">Tuple</span> newTuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//合并</span>
                    newTuple<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> td1<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        newTuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> td2<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        newTuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>i <span class="token operator">+</span> j<span class="token punctuation">,</span> t2<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//遍历t2后重置，准备遍历下一个t</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>child2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> newTuple<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            child2<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>child1<span class="token punctuation">,</span> child2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child1 <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        child2 <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br></div></div><p>完成本节练习之后，需要通过PredicateTest, JoinPredicateTest, FilterTest, JoinTest单元测试；并通过FilterTest和JoinTest系统测试</p> <h3 id="_2-2-aggregates"><a href="#_2-2-aggregates" class="header-anchor">#</a> 2.2 Aggregates</h3> <p>本节我们应该实现如下五种聚合操作：count、sum、avg、min、max，并且支持分组聚合操作。仅支持对一个域进行聚合，对一个域进行分组即可</p> <p>为了实现聚合操作，我们使用Aggregator接口将新的元组合并到现有的聚合操作结果中，实际进行哪种聚合操作会在构造Aggregate时指明。所以，客户端代码需要为子操作的每个元组调用<code>Aggregator.mergeTupleIntoGroup()</code>方法，当所有的元组都被合并完成以后，客户端将会获得聚合操作的结果。如果指定分组的话，那么返回结果格式为:<code>(groupValue, aggregateValue)</code>；没有指定分组的话，返回格式为：<code>(aggregateValue)</code></p> <p>本节实验中，我们不需要担心分组的数量超过可用内存的限制。</p> <p><strong>练习2</strong></p> <p>实现如下类中的方法：</p> <ul><li>src/java/simpledb/execution/IntegerAggregator.java</li> <li>src/java/simpledb/execution/StringAggregator.java</li> <li>src/java/simpledb/execution/Aggregate.java</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Knows how to compute some aggregate over a set of IntFields.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntegerAggregator</span> <span class="token keyword">implements</span> <span class="token class-name">Aggregator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token comment">// 分组字段的序号（是一个字段，用于辨别是否是该类型）举例：group by 字段</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> gbfield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">;</span>
    <span class="token comment">// 聚合字段的序号（是用于取新插入的值） 举例： sum(字段),min(字段)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Op</span> what<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">AggHandler</span> aggHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>
        <span class="token comment">//存储对应的聚合结果</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> aggResult<span class="token punctuation">;</span>
        <span class="token comment">//gbfield用于分组的字段,aggField现在聚合结果</span>
        <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">AggHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            aggResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAggResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> aggResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MinHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> value <span class="token operator">=</span> aggField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">MaxHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> value <span class="token operator">=</span> aggField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">AvgHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> value <span class="token operator">=</span> aggField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//求和加计数</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>sum<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> count<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                sum<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> sum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                sum<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> sum<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">/</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SumHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> value <span class="token operator">=</span> aggField<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> aggResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">CountHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AggHandler</span><span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">Field</span> gbField<span class="token punctuation">,</span> <span class="token class-name">IntField</span> aggField<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>aggResult<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> aggResult<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>gbField<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                aggResult<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>gbField<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Aggregate constructor
     * 
     * @param gbfield
     *            the 0-based index of the group-by field in the tuple, or
     *            NO_GROUPING if there is no grouping
     * @param gbfieldtype
     *            the type of the group by field (e.g., Type.INT_TYPE), or null
     *            if there is no grouping
     * @param afield
     *            the 0-based index of the aggregate field in the tuple
     * @param what
     *            the aggregation operator
     */</span>

    <span class="token keyword">public</span> <span class="token class-name">IntegerAggregator</span><span class="token punctuation">(</span><span class="token keyword">int</span> gbfield<span class="token punctuation">,</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token class-name">Op</span> what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">=</span> gbfield<span class="token punctuation">;</span><span class="token comment">//分组字段序号</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype <span class="token operator">=</span> gbfieldtype<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span><span class="token comment">//聚合字段的序号</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span><span class="token comment">//操作符</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>what<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">MIN</span><span class="token operator">:</span>
                aggHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MinHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">MAX</span><span class="token operator">:</span>
                aggHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MaxHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">AVG</span><span class="token operator">:</span>
                aggHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AvgHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">SUM</span><span class="token operator">:</span>
                aggHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">COUNT</span><span class="token operator">:</span>
                aggHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;聚合器不支持当前运算符&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Merge a new tuple into the aggregate, grouping as indicated in the
     * constructor
     * 
     * @param tup
     *            the Tuple containing an aggregate field and a group-by field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//获取处理值得字段</span>
        <span class="token class-name">IntField</span> afield <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span>tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>afield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//分组字段</span>
        <span class="token class-name">Field</span> gbfield <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">==</span> <span class="token constant">NO_GROUPING</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        aggHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">,</span> afield<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a OpIterator over group aggregate results.
     * 
     * @return a OpIterator whose tuples are the pair (groupVal, aggregateVal)
     *         if using group, or a single (aggregateVal) if no grouping. The
     *         aggregateVal is determined by the type of aggregate specified in
     *         the constructor.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//获取聚合集</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> aggHandler<span class="token punctuation">.</span><span class="token function">getAggResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构造tuple</span>
        <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types<span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">;</span>
        <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
        <span class="token comment">//存储结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gbfield <span class="token operator">==</span> <span class="token constant">NO_GROUPING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;aggregateVal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//获取结果字段</span>
            <span class="token class-name">IntField</span> resultField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//组合成行</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> resultField<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>gbfieldtype<span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;groupType&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;aggregateVal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> t <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>gbfieldtype <span class="token operator">==</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">IntField</span> intField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span>
                    tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> intField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>gbfieldtype <span class="token operator">==</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">STRING_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">StringField</span> stringField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringField</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>
                    tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stringField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">IntField</span> resultField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>resultField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TupleIterator</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">,</span> tuples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Knows how to compute some aggregate over a set of StringFields.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringAggregator</span> <span class="token keyword">implements</span> <span class="token class-name">Aggregator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token comment">// 分组字段的序号（是一个字段，用于辨别是否是该类型）举例：group by 字段</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> gbfield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">;</span>
    <span class="token comment">// 聚合字段的序号（是用于取新插入的值） 举例： sum(字段),min(字段)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Op</span> what<span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Field</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Aggregate constructor
     * @param gbfield the 0-based index of the group-by field in the tuple, or NO_GROUPING if there is no grouping
     * @param gbfieldtype the type of the group by field (e.g., Type.INT_TYPE), or null if there is no grouping
     * @param afield the 0-based index of the aggregate field in the tuple
     * @param what aggregation operator to use -- only supports COUNT
     * @throws IllegalArgumentException if what != COUNT
     */</span>

    <span class="token keyword">public</span> <span class="token class-name">StringAggregator</span><span class="token punctuation">(</span><span class="token keyword">int</span> gbfield<span class="token punctuation">,</span> <span class="token class-name">Type</span> gbfieldtype<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token class-name">Op</span> what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>what<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Op</span><span class="token punctuation">.</span><span class="token constant">COUNT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;String类型只支持计数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfield <span class="token operator">=</span> gbfield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gbfieldtype <span class="token operator">=</span> gbfieldtype<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>what <span class="token operator">=</span> what<span class="token punctuation">;</span>
        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Merge a new tuple into the aggregate, grouping as indicated in the constructor
     * @param tup the Tuple containing an aggregate field and a group-by field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> tup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">Field</span> field <span class="token operator">=</span> gbfield <span class="token operator">==</span> <span class="token constant">NO_GROUPING</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> tup<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>gbfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Create a OpIterator over group aggregate results.
     *
     * @return a OpIterator whose tuples are the pair (groupVal,
     *   aggregateVal) if using group, or a single (aggregateVal) if no
     *   grouping. The aggregateVal is determined by the type of
     *   aggregate specified in the constructor.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//构造tuple</span>
        <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> types<span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> names<span class="token punctuation">;</span>
        <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
        <span class="token comment">//存储结果</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> tuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gbfield <span class="token operator">==</span> <span class="token constant">NO_GROUPING</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;aggregateVal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//组合成行</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>gbfieldtype<span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            names <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;groupType&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;aggregateVal&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> names<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Field</span> t <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>gbfieldtype <span class="token operator">==</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">IntField</span> intField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span>t<span class="token punctuation">;</span>
                    tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> intField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>gbfieldtype <span class="token operator">==</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">STRING_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token class-name">StringField</span> stringField <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringField</span><span class="token punctuation">)</span> t<span class="token punctuation">;</span>
                    tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stringField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">IntField</span> resultField <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>resultField<span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TupleIterator</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">,</span> tuples<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">NoSuchElementException</span></span><span class="token punctuation">;</span>


<span class="token comment">/**
 * The Aggregation operator that computes an aggregate (e.g., sum, avg, max,
 * min). Note that we only support aggregates over a single column, grouped by a
 * single column.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Aggregate</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    <span class="token comment">//需要聚合的tuples</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> afield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> gfield<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">;</span>

    <span class="token comment">//进行聚合运算操作的类</span>
    <span class="token keyword">private</span> <span class="token class-name">Aggregator</span> aggregator<span class="token punctuation">;</span>
    <span class="token comment">//聚合结果迭代器</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> opIterator<span class="token punctuation">;</span>
    <span class="token comment">//聚合结果属性行</span>
    <span class="token keyword">private</span> <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor.
     * &lt;p&gt;
     * Implementation hint: depending on the type of afield, you will want to
     * construct an {@link IntegerAggregator} or {@link StringAggregator} to help
     * you with your implementation of readNext().
     *
     * @param child  The OpIterator that is feeding us tuples.
     * @param afield The column over which we are computing an aggregate.
     * @param gfield The column over which we are grouping the result, or -1 if
     *               there is no grouping
     * @param aop    The aggregation operator to use
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Aggregate</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> afield<span class="token punctuation">,</span> <span class="token keyword">int</span> gfield<span class="token punctuation">,</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>afield <span class="token operator">=</span> afield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gfield <span class="token operator">=</span> gfield<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aop <span class="token operator">=</span> aop<span class="token punctuation">;</span>
        <span class="token comment">//判断是否分组</span>
        <span class="token class-name">Type</span> gfieldtype <span class="token operator">=</span> gfield <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建聚合器</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">STRING_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringAggregator</span><span class="token punctuation">(</span>gfield<span class="token punctuation">,</span> gfieldtype<span class="token punctuation">,</span> afield<span class="token punctuation">,</span> aop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aggregator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntegerAggregator</span><span class="token punctuation">(</span>gfield<span class="token punctuation">,</span> gfieldtype<span class="token punctuation">,</span> afield<span class="token punctuation">,</span> aop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//组建tupleDesc</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> typeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nameList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gfieldtype <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>aop<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">SUM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;COUNT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>typeList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span>typeList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nameList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>nameList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * @return If this aggregate is accompanied by a groupby, return the groupby
     * field index in the &lt;b&gt;INPUT&lt;/b&gt; tuples. If not, return
     * {@link Aggregator#NO_GROUPING}
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">groupField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> gfield<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return If this aggregate is accompanied by a group by, return the name
     * of the groupby field in the &lt;b&gt;OUTPUT&lt;/b&gt; tuples. If not, return
     * null;
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">groupFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the aggregate field
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">aggregateField</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> afield<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return return the name of the aggregate field in the &lt;b&gt;OUTPUT&lt;/b&gt;
     * tuples
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">aggregateFieldName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gfield <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return return the aggregate operator
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> <span class="token function">aggregateOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> aop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">nameOfAggregatorOp</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span> aop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> aop<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//聚合所有tuple</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            aggregator<span class="token punctuation">.</span><span class="token function">mergeTupleIntoGroup</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取聚合后的结果</span>
        opIterator <span class="token operator">=</span> aggregator<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询</span>
        opIterator<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//使得父类状态保持一致</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the next tuple. If there is a group by field, then the first
     * field is the field by which we are grouping, and the second field is the
     * result of computing the aggregate. If there is no group by field, then
     * the result tuple should contain one field representing the result of the
     * aggregate. Should return null if there are no more tuples.
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>opIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> opIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opIterator<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the TupleDesc of this Aggregate. If there is no group by field,
     * this will have one field - the aggregate column. If there is a group by
     * field, the first field will be the group by field, and the second will be
     * the aggregate value column.
     * &lt;p&gt;
     * The name of an aggregate column should be informative. For example:
     * &quot;aggName(aop) (child_td.getFieldName(afield))&quot; where aop and afield are
     * given in the constructor, and child_td is the TupleDesc of the child
     * iterator.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opIterator<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">Type</span> gfieldtype <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//组建tupleDesc</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Type</span><span class="token punctuation">&gt;</span></span> typeList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> nameList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>gfieldtype <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>gfieldtype<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>gfield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFieldName</span><span class="token punctuation">(</span>afield<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>aop<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Aggregator<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">SUM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            typeList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            nameList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;COUNT&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span>typeList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span>typeList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nameList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span>nameList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br></div></div><p>完成本练习之后，需要通过IntegerAggregatorTest, StringAggregatorTest, and AggregateTest单元测试，以及AggregateTest系统测试 .</p> <h3 id="_2-3-heapfile-mutability"><a href="#_2-3-heapfile-mutability" class="header-anchor">#</a> 2.3 HeapFile Mutability</h3> <p>本节我们将实现修改数据库表文件的方法，我们从单独的页面和文件开始，主要实现两种操作：增加元组和移除元组</p> <p>移除元组：为了移除一个元组，我们需要实现<code>deleteTuple</code>方法，元组包含<code>RecordIDs</code>可以帮助我们找到它们存储在哪一页，所以定位到元组对应的page并且正确修改page的headers信息就很简单了</p> <p>增加元组：<code>HeapFile</code>中的<code>insertTuple</code>方法主要用于向数据库文件添加一个元组。为了向HeapFile中添加一个新的元组，我们需要找到带有空槽的页，如果不存在这样的页，我们需要创造一个新页并且将其添加到磁盘的文件上。我们需要确保元组的RecordID被正确更新</p> <p><strong>练习3</strong></p> <p>实现如下类中的方法：</p> <ul><li>src/java/simpledb/storage/HeapPage.java</li> <li>src/java/simpledb/storage/HeapFile.java (Note that you do not necessarily need to implement writePage at this point).</li></ul> <p>为了实现HeapPage，在insertTuple和deleteTuple方法中你需要修改表示header的bitmap；这里将会使用到我们在实验一中实现的getNumEmptySlots()和isSlotUsed方法，markSlotUsed方法是抽象方法，并且用于填充或者清除page header的的状态信息</p> <p>注意，insertTuple和deleteTuple方法需要通过BufferPool.getPage方法访问页，否则下一个实验中关于事务的实现将无法正常工作.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Catalog</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Each instance of HeapPage stores data for one page of HeapFiles and 
 * implements the Page interface that is used by BufferPool.
 *
 * @see HeapFile
 * @see BufferPool
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapPage</span> <span class="token keyword">implements</span> <span class="token class-name">Page</span> <span class="token punctuation">{</span>

    <span class="token keyword">final</span> <span class="token class-name">HeapPageId</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> header<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">Tuple</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tuples<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">int</span> numSlots<span class="token punctuation">;</span>

    <span class="token comment">//事务id</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
    <span class="token comment">//是否是脏页</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> dirty<span class="token punctuation">;</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldData<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Byte</span> oldDataLock<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Create a HeapPage from a set of bytes of data read from disk.
     * The format of a HeapPage is a set of header bytes indicating
     * the slots of the page that are in use, some number of tuple slots.
     *  Specifically, the number of tuples is equal to: &lt;p&gt;
     *          floor((BufferPool.getPageSize()*8) / (tuple size * 8 + 1))
     * &lt;p&gt; where tuple size is the size of tuples in this
     * database table, which can be determined via {@link Catalog#getTupleDesc}.
     * The number of 8-bit header words is equal to:
     * &lt;p&gt;
     *      ceiling(no. tuple slots / 8)
     * &lt;p&gt;
     * @see Database#getCatalog
     * @see Catalog#getTupleDesc
     * @see BufferPool#getPageSize()
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span><span class="token class-name">HeapPageId</span> id<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pid <span class="token operator">=</span> id<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numSlots <span class="token operator">=</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataInputStream</span> dis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// allocate and read the header slots of this page</span>
        header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>header<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            header<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        tuples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">[</span>numSlots<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token comment">// allocate and read the actual records of this page</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">readNextTuple</span><span class="token punctuation">(</span>dis<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Retrieve the number of tuples on this page.
        @return the number of tuples on this page
    */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//除了数据需要的大小，还需要一个bit位标记是否已被使用</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Computes the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     * @return the number of bytes in the header of a page in a HeapFile with each tuple occupying tupleSize bytes
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">getHeaderSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        
        <span class="token comment">//一个元组一个槽</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token function">getNumTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 
    <span class="token punctuation">}</span>
    
    <span class="token comment">/** Return a view of this page before it was modified
        -- used by recovery */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPage</span> <span class="token function">getBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> oldDataRef <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                oldDataRef <span class="token operator">=</span> oldData<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span>oldDataRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//should never happen -- we parsed it OK before!</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span><span class="token punctuation">(</span>oldDataLock<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        oldData <span class="token operator">=</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return the PageId associated with this page.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapPageId</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> pid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Suck up tuples from the source file.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Tuple</span> <span class="token function">readNextTuple</span><span class="token punctuation">(</span><span class="token class-name">DataInputStream</span> dis<span class="token punctuation">,</span> <span class="token keyword">int</span> slotId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchElementException</span> <span class="token punctuation">{</span>
        <span class="token comment">// if associated bit is not set, read forward to the next tuple, and</span>
        <span class="token comment">// return null.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>slotId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    dis<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">&quot;error reading empty tuple&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// read fields in the tuple</span>
        <span class="token class-name">Tuple</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RecordId</span> rid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RecordId</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> slotId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span>rid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Field</span> f <span class="token operator">=</span> td<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>dis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>text<span class="token punctuation">.</span></span>ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">&quot;parsing error!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Generates a byte array representing the contents of this page.
     * Used to serialize this page to disk.
     * &lt;p&gt;
     * The invariant here is that it should be possible to pass the byte
     * array generated by getPageData to the HeapPage constructor and
     * have it produce an identical HeapPage object.
     *
     * @see #HeapPage
     * @return A byte array correspond to the bytes of this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataOutputStream</span> dos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// create the header of the page</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">byte</span> b <span class="token operator">:</span> header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// this really shouldn't happen</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// create the tuples</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>tuples<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// empty slot</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        dos<span class="token punctuation">.</span><span class="token function">writeByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// non-empty slot</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span>td<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Field</span> f <span class="token operator">=</span> tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    f<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>dos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// padding</span>
        <span class="token keyword">int</span> zerolen <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span>length <span class="token operator">+</span> td<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> tuples<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//- numSlots * td.getSize();</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> zeroes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>zerolen<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            dos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>zeroes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> zerolen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            dos<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Static method to generate a byte array corresponding to an empty
     * HeapPage.
     * Used to add new, empty pages to the file. Passing the results of
     * this method to the HeapPage constructor will create a HeapPage with
     * no valid tuples in it.
     *
     * @return The returned ByteArray.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">createEmptyPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//all 0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Delete the specified tuple from the page; the corresponding header bit should be updated to reflect
     *   that it is no longer stored on any page.
     * @throws DbException if this tuple is not on this page, or tuple slot is
     *         already empty.
     * @param t The tuple to delete
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token comment">//查看属性是否匹配</span>
        <span class="token keyword">int</span> tupleId <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTupleNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tuples<span class="token punctuation">[</span>tupleId<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">&quot;this tuple is not on this page&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>tupleId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">&quot;tuple slot is already empty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//标记未使用</span>
        <span class="token function">markSlotUsed</span><span class="token punctuation">(</span>tupleId<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//删除插槽内容</span>
        tuples<span class="token punctuation">[</span>tupleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Adds the specified tuple to the page;  the tuple should be updated to reflect
     *  that it is now stored on this page.
     * @throws DbException if the page is full (no empty slots) or tupledesc
     *         is mismatch.
     * @param t The tuple to add.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token comment">//查看Page是否已满</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">&quot;当前页已满&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查看属性是否匹配</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>td<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">&quot;类型不匹配&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//查询tuple</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//标记使用</span>
                <span class="token function">markSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//设置路径</span>
                t<span class="token punctuation">.</span><span class="token function">setRecordId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RecordId</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Marks this page as dirty/not dirty and record that transaction
     * that did the dirtying
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> dirty<span class="token punctuation">,</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dirty <span class="token operator">=</span> dirty<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> tid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the tid of the transaction that last dirtied this page, or null if the page is not dirty
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TransactionId</span> <span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
	<span class="token comment">// Not necessary for lab1</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dirty<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> tid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the number of empty slots on this page.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token operator">++</span>cnt<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns true if associated slot on this page is filled.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//user header</span>
        <span class="token comment">// 槽位</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token comment">// 偏移</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得对应的槽位</span>
        <span class="token keyword">int</span> quot <span class="token operator">=</span> header<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得对应的槽位</span>
        <span class="token keyword">int</span> reminder <span class="token operator">=</span> <span class="token punctuation">(</span>quot <span class="token operator">&gt;&gt;</span> b <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 偏移 move 位，看是否等于 1</span>
        <span class="token keyword">return</span> reminder <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Abstraction to fill or clear a slot on this page.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">markSlotUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">boolean</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token comment">//槽位</span>
        <span class="token keyword">int</span> slot <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token comment">//偏移量</span>
        <span class="token keyword">int</span> move <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token comment">//该位变成1</span>
        <span class="token keyword">byte</span> mask <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> move<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//0更新为1</span>
            header<span class="token punctuation">[</span>slot<span class="token punctuation">]</span> <span class="token operator">|=</span> mask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">// 标记为未被使用，更新 1 为 0</span>
            <span class="token comment">// 除了该位其他位都是 1 的掩码，也就是该位会与 0 运算, 从而置零</span>
            header<span class="token punctuation">[</span>slot<span class="token punctuation">]</span> <span class="token operator">&amp;=</span> <span class="token operator">~</span>mask<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * @return an iterator over all tuples on this page (calling remove on this iterator throws an UnsupportedOperationException)
     * (note that this iterator shouldn't return tuples in empty slots!)
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> ans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numSlots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSlotUsed</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                ans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tuples<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> ans<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Debug</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Permissions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">Transaction</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * HeapFile is an implementation of a DbFile that stores a collection of tuples
 * in no particular order. Tuples are stored on pages, each of which is a fixed
 * size, and the file is simply a collection of those pages. HeapFile works
 * closely with HeapPage. The format of HeapPages is described in the HeapPage
 * constructor.
 * 
 * @see HeapPage#HeapPage
 * @author Sam Madden
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapFile</span> <span class="token keyword">implements</span> <span class="token class-name">DbFile</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">File</span> file<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructs a heap file backed by the specified file.
     * 
     * @param f
     *            the file that stores the on-disk backing store for this heap
     *            file.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">HeapFile</span><span class="token punctuation">(</span><span class="token class-name">File</span> f<span class="token punctuation">,</span> <span class="token class-name">TupleDesc</span> td<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> f<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>td <span class="token operator">=</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the File backing this HeapFile on disk.
     * 
     * @return the File backing this HeapFile on disk.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">File</span> <span class="token function">getFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns an ID uniquely identifying this HeapFile. Implementation note:
     * you will need to generate this tableid somewhere to ensure that each
     * HeapFile has a &quot;unique id,&quot; and that you always return the same value for
     * a particular HeapFile. We suggest hashing the absolute file name of the
     * file underlying the heapfile, i.e. f.getAbsoluteFile().hashCode().
     * 
     * @return an ID uniquely identifying this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// 文件的绝对路径，取hash。独一无二的id</span>
        <span class="token keyword">return</span> file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the TupleDesc of the table stored in this DbFile.
     * 
     * @return TupleDesc of this DbFile.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> td<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">Page</span> <span class="token function">readPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> tableId <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pgNo <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//随机访问</span>
        <span class="token class-name">RandomAccessFile</span> f <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//读取当前文件</span>
            f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//当前页号*每页字节大小 是否超出文件范围</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>pgNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> f<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;表 %d 页 %d 不存在&quot;</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//用于存储</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment">//指针偏移</span>
            f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pgNo <span class="token operator">*</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//读取(返回读取的数量)</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//如果取出少，说明不存在</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>read <span class="token operator">!=</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;表 %d 页 %d 不存在&quot;</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapPage</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pid<span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span><span class="token punctuation">{</span>
                <span class="token comment">// 关闭流</span>
                f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;表 %d 页 %d 不存在&quot;</span><span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> pgNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writePage</span><span class="token punctuation">(</span><span class="token class-name">Page</span> page<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token comment">//获取页面序号</span>
        <span class="token keyword">int</span> pageId <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不能超过最大页面数</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pageId <span class="token operator">&gt;</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//创建写入工具</span>
        <span class="token class-name">RandomAccessFile</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">&quot;rw&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//跳过前面页面</span>
        f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span>pageId <span class="token operator">*</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//写入数据</span>
        f<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        f<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Returns the number of pages in this HeapFile.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token class-name">BufferPool</span><span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//查询现有的页</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNo <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pageNo <span class="token operator">&lt;</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pageNo<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//查询页</span>
            <span class="token class-name">HeapPageId</span> heapPageId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pageNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HeapPage</span> heapPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> heapPageId<span class="token punctuation">,</span> <span class="token class-name">Permissions</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//看当前页是否有空闲空间</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>heapPage<span class="token punctuation">.</span><span class="token function">getNumEmptySlots</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unsafeReleasePage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> heapPage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            heapPage<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>heapPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> list<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment">//如果所有页都写满,就要新建新的页面来加入(记得开启 append = true 也就是增量增加)</span>
        <span class="token class-name">BufferedOutputStream</span> bufferedOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//新建一个空页</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> emptyPage <span class="token operator">=</span> <span class="token class-name">HeapPage</span><span class="token punctuation">.</span><span class="token function">createEmptyPageData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>emptyPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//close前会flush刷到文件中</span>
        bufferedOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建新的页面</span>
        <span class="token class-name">HeapPageId</span> pageId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HeapPage</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> pageId<span class="token punctuation">,</span> <span class="token class-name">Permissions</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//表明这是脏页</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span>
            <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PageId</span> pageId <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//找到相应页</span>
        <span class="token class-name">HeapPage</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> pageId<span class="token punctuation">,</span> <span class="token class-name">Permissions</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// see DbFile.java for javadocs</span>
    <span class="token keyword">public</span> <span class="token class-name">DbFileIterator</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeapFileItrator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HeapFileItrator</span> <span class="token keyword">implements</span> <span class="token class-name">DbFileIterator</span><span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HeapFile</span> heapFile<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
        <span class="token comment">//元组迭代器</span>
        <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> iterator<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> whichPage<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token class-name">HeapFileItrator</span><span class="token punctuation">(</span><span class="token class-name">HeapFile</span> heapFile<span class="token punctuation">,</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heapFile <span class="token operator">=</span> heapFile<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> tid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
            <span class="token comment">//获取第一页的全部元组</span>
            whichPage <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            iterator <span class="token operator">=</span> <span class="token function">getPageTuple</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//获取当前页的所有行</span>
        <span class="token keyword">private</span> <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple</span><span class="token punctuation">&gt;</span></span> <span class="token function">getPageTuple</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageNumber<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
            <span class="token comment">//在文件范围内</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>pageNumber <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pageNumber <span class="token operator">&lt;</span> heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//对应一个表id,一个heapFile</span>
                <span class="token class-name">HeapPageId</span> pid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeapPageId</span><span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pageNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//从缓存中查询相应的页面</span>
                <span class="token class-name">HeapPage</span> page <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HeapPage</span><span class="token punctuation">)</span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPage</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> pid<span class="token punctuation">,</span> <span class="token class-name">Permissions</span><span class="token punctuation">.</span><span class="token constant">READ_ONLY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> page<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;heapFile %d not contain page %d&quot;</span><span class="token punctuation">,</span> pageNumber<span class="token punctuation">,</span> heapFile<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
            <span class="token comment">//如果迭代器为空</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>iterator <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//如果遍历结束</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//还有下一页</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>whichPage <span class="token operator">&lt;</span> <span class="token punctuation">(</span>heapFile<span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    whichPage<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment">//获取下一页</span>
                    iterator <span class="token operator">=</span> <span class="token function">getPageTuple</span><span class="token punctuation">(</span>whichPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">return</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//所有元组获取完毕</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Tuple</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchElementException</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>iterator <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//没有元组</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NoSuchElementException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//返回下一个元组</span>
            <span class="token keyword">return</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
            <span class="token comment">//清除上一个</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//重新开始</span>
            <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iterator <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br><span class="line-number">626</span><br><span class="line-number">627</span><br><span class="line-number">628</span><br><span class="line-number">629</span><br><span class="line-number">630</span><br><span class="line-number">631</span><br><span class="line-number">632</span><br><span class="line-number">633</span><br><span class="line-number">634</span><br><span class="line-number">635</span><br><span class="line-number">636</span><br><span class="line-number">637</span><br><span class="line-number">638</span><br><span class="line-number">639</span><br><span class="line-number">640</span><br><span class="line-number">641</span><br><span class="line-number">642</span><br><span class="line-number">643</span><br><span class="line-number">644</span><br><span class="line-number">645</span><br><span class="line-number">646</span><br><span class="line-number">647</span><br><span class="line-number">648</span><br><span class="line-number">649</span><br><span class="line-number">650</span><br><span class="line-number">651</span><br><span class="line-number">652</span><br><span class="line-number">653</span><br><span class="line-number">654</span><br><span class="line-number">655</span><br><span class="line-number">656</span><br><span class="line-number">657</span><br><span class="line-number">658</span><br><span class="line-number">659</span><br><span class="line-number">660</span><br><span class="line-number">661</span><br><span class="line-number">662</span><br><span class="line-number">663</span><br><span class="line-number">664</span><br><span class="line-number">665</span><br><span class="line-number">666</span><br><span class="line-number">667</span><br><span class="line-number">668</span><br><span class="line-number">669</span><br><span class="line-number">670</span><br><span class="line-number">671</span><br><span class="line-number">672</span><br><span class="line-number">673</span><br><span class="line-number">674</span><br><span class="line-number">675</span><br><span class="line-number">676</span><br></div></div><p>完成练习后，我们的代码需要通过HeapPageWriteTest、HeapFileWriteTest和BufferPoolWriteTest单元测试 .</p> <p>实现BufferPool类中的如下方法：</p> <ul><li>insertTuple()</li> <li>deleteTuple()</li></ul> <p>这些方法需要调用需要被修改的表的HeapFile中的合适的方法来实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * Add a tuple to the specified table on behalf of transaction tid.  Will
     * acquire a write lock on the page the tuple is added to and any other
     * pages that are updated (Lock acquisition is not needed for lab2).
     * May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have
     * been dirtied to the cache (replacing any existing versions of those pages) so
     * that future requests see up-to-date pages.
     *
     * @param tid the transaction adding the tuple
     * @param tableId the table to add the tuple to
     * @param t the tuple to add
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Remove the specified tuple from the buffer pool.
     * Will acquire a write lock on the page the tuple is removed from and any
     * other pages that are updated. May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have
     * been dirtied to the cache (replacing any existing versions of those pages) so
     * that future requests see up-to-date pages.
     *
     * @param tid the transaction deleting the tuple.
     * @param t the tuple to delete
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>完成练习后，我们的代码需要通过HeapPageWriteTest、HeapFileWriteTest和BufferPoolWriteTest单元测试</p> <h3 id="_2-4-insertion-deletion"><a href="#_2-4-insertion-deletion" class="header-anchor">#</a> 2.4 Insertion &amp; deletion</h3> <p>现在我们已经实现了向HeapFile添加和删除元组的机制，接下来就需要实现Insert和Delete操作</p> <p>为了实现insert和delete查询，我们需要使用Insert和Delete来修改磁盘上的页，这些操作会返回被影响的元组数量</p> <ul><li>Insert：该操作从他的子操作中读取元组加入到构造函数指定的tableid对应的表中，需要调用BufferPool.insertTuple()方法实现</li> <li>Delete：该操作从构造函数的tableid找到对应的table，并删除子操作中的元组，需要调用BufferPool.deleteTuple方法实现</li></ul> <p><strong>练习4</strong></p> <p>实现如下类中的方法：</p> <ul><li>src/java/simpledb/execution/Insert.java</li> <li>src/java/simpledb/execution/Delete.java</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">BufferPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">IntField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Inserts tuples read from the child operator into the tableId specified in the
 * constructor
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Insert</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> transactionId<span class="token punctuation">;</span>
    <span class="token comment">//插入的元组，迭代器</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">;</span>
    <span class="token comment">//要插入的表位置</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> tableId<span class="token punctuation">;</span>
    <span class="token comment">//标志位，避免fetchNext无限向下取</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> inserted<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor.
     *
     * @param t
     *            The transaction running the insert.
     * @param child
     *            The child operator from which to read tuples to be inserted.
     * @param tableId
     *            The table in which to insert tuples.
     * @throws DbException
     *             if TupleDesc of child differs from table into which we are to
     *             insert.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Insert</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> t<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transactionId <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableId <span class="token operator">=</span> tableId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;the number of inserted tuple&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inserted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        child<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        child<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        inserted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Inserts tuples read from child into the tableId specified by the
     * constructor. It returns a one field tuple containing the number of
     * inserted records. Inserts should be passed through BufferPool. An
     * instances of BufferPool is available via Database.getBufferPool(). Note
     * that insert DOES NOT need check to see if a particular tuple is a
     * duplicate before inserting it.
     *
     * @return A 1-field tuple containing the number of inserted records, or
     *         null if called more than once.
     * @see Database#getBufferPool
     * @see BufferPool#insertTuple
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">//还未插入</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>inserted<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//计算插入了多少hang</span>
            inserted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Tuple</span> t <span class="token operator">=</span> child<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">,</span> tableId<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cnt<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//返回插入的次数 所组成元组</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            tuple<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> tuple<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>child<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>execution</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">BufferPool</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">IntField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">Tuple</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The delete operator. Delete reads tuples from its child operator and removes
 * them from the table they belong to.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Delete</span> <span class="token keyword">extends</span> <span class="token class-name">Operator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">;</span>
    <span class="token comment">//要删除的元组迭代器</span>
    <span class="token keyword">private</span> <span class="token class-name">OpIterator</span> opIterator<span class="token punctuation">;</span>
    <span class="token comment">//是否已经删除</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> isDeleted<span class="token punctuation">;</span>
    <span class="token comment">//返回删除行的数量</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Constructor specifying the transaction that this delete belongs to as
     * well as the child to read from.
     * 
     * @param t
     *            The transaction this delete runs in
     * @param child
     *            The child operator from which to read tuples for deletion
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Delete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> t<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> child<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tid <span class="token operator">=</span> t<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>opIterator <span class="token operator">=</span> child<span class="token punctuation">;</span>
        isDeleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        tupleDesc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TupleDesc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">&quot;the number of delete tuple&quot;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">TupleDesc</span> <span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        opIterator<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opIterator<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        opIterator<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isDeleted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Deletes tuples as they are read from the child operator. Deletes are
     * processed via the buffer pool (which can be accessed via the
     * Database.getBufferPool() method.
     * 
     * @return A 1-field tuple containing the number of deleted records.
     * @see Database#getBufferPool
     * @see BufferPool#deleteTuple
     */</span>
    <span class="token keyword">protected</span> <span class="token class-name">Tuple</span> <span class="token function">fetchNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isDeleted<span class="token punctuation">)</span><span class="token punctuation">{</span>
            isDeleted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span>opIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> opIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> tuple<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cnt<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Tuple</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">IntField</span><span class="token punctuation">(</span>cnt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>opIterator<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setChildren</span><span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>opIterator <span class="token operator">=</span> children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br></div></div><p>完成实验后需要通过InsertTest单元测试，并且通过InsertTest和DeleteTest系统测试 .</p> <h3 id="_2-5-page-eviction"><a href="#_2-5-page-eviction" class="header-anchor">#</a> 2.5 Page eviction</h3> <p>在实验一中，我们没有正确的根据BufferPool构造函数中定义的numPages对BufferPool中缓存的最大页面数量进行限制，本节我们将实现拒绝策略</p> <p>当缓冲池中存在超过numPages数量的页时，我们需要在加载下一个页时选择淘汰缓冲池中现存的一个页；具体的拒绝策略我们自己选择即可</p> <p>BufferPool中包含一个<code>flushAllPages</code>方法，该方法不会被实际用到，只是用来进行实际的测试，我们在实际代码中不会调用此方法</p> <p>flushAllPages方法需要调用flushPage方法，并且flushPage方法需要在page离开BufferPool时将脏页写入磁盘，并且将其置为非脏</p> <p>从缓冲池中移除页面的唯一方法是evictPage，当任何脏页被丢弃时，我们需要调用flushPage方法来将其刷新到磁盘</p> <p>如果学过操作系统，那么应该了解过缓存页面丢弃策略，主要有先进先出(FIFO)、最近最少使用(LRU)和最不常用(LFU)这几种方法，我们可以选择不同的策略实现。我这里给定了一个抽象的接口，定义好方法，最后实现了LRU页面丢弃策略，详情请看代码</p> <p><strong>练习5</strong></p> <p>实现BufferPool的页面丢弃策略：</p> <ul><li>src/java/simpledb/storage/BufferPool.java</li></ul> <p>我们需要实现discardPage方法去移除缓冲池中没有被刷新到磁盘上的页</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>evict</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">PageId</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @description:    丢弃策略的抽象接口
 */</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">EvictStrategy</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 修改对应的数据结构以满足丢弃策略
     * @param pageId
     */</span>
    <span class="token keyword">void</span> <span class="token function">modifyData</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pageId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取要丢弃的Page的PageId信息,用于丢弃
     * @return  PageId
     */</span>
    <span class="token class-name">PageId</span> <span class="token function">getEvictPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>evict</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">PageId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LRUEvict</span> <span class="token keyword">implements</span> <span class="token class-name">EvictStrategy</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">DLinkedNode</span> head<span class="token punctuation">,</span> tail<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">LRUEvict</span><span class="token punctuation">(</span><span class="token keyword">int</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
        map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>numPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">modifyData</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pageId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pageId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLinkedNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">moveToHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">DLinkedNode</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">(</span>pageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pageId<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addToHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageId</span> <span class="token function">getEvictPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">removeTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addToHead</span><span class="token punctuation">(</span><span class="token class-name">DLinkedNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>next<span class="token punctuation">.</span>prev <span class="token operator">=</span> node<span class="token punctuation">;</span>
        head<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token class-name">DLinkedNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>prev<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>next<span class="token punctuation">.</span>prev <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">moveToHead</span><span class="token punctuation">(</span><span class="token class-name">DLinkedNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">removeNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addToHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">DLinkedNode</span> <span class="token function">removeTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DLinkedNode</span> res <span class="token operator">=</span> tail<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token function">removeNode</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>evict</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">PageId</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DLinkedNode</span> <span class="token punctuation">{</span>
    <span class="token class-name">PageId</span> value<span class="token punctuation">;</span>
    <span class="token class-name">DLinkedNode</span> prev<span class="token punctuation">;</span>
    <span class="token class-name">DLinkedNode</span> next<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">DLinkedNode</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PageId</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><p>页面丢弃策略：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>storage</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>evict<span class="token punctuation">.</span></span><span class="token class-name">EvictStrategy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>evict<span class="token punctuation">.</span></span><span class="token class-name">LRUEvict</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>lock<span class="token punctuation">.</span></span><span class="token class-name">LockManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * BufferPool manages the reading and writing of pages into memory from
 * disk. Access methods call into it to retrieve pages, and it fetches
 * pages from the appropriate location.
 * &lt;p&gt;
 * The BufferPool is also responsible for locking;  when a transaction fetches
 * a page, BufferPool checks that the transaction has the appropriate
 * locks to read/write the page.
 *
 * @Threadsafe, all fields are final
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BufferPool</span> <span class="token punctuation">{</span>
    <span class="token comment">/** Bytes per page, including header. */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_PAGE_SIZE</span> <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> pageSize <span class="token operator">=</span> <span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>

    <span class="token comment">/** Default number of pages passed to the constructor. This is used by
     other classes. BufferPool should use the numPages argument to the
     constructor instead. */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_PAGES</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> numPages<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pageCache<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">EvictStrategy</span> evict<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">LockManager</span> lockManager<span class="token punctuation">;</span>


    <span class="token comment">/**
     * Creates a BufferPool that caches up to numPages pages.
     *
     * @param numPages maximum number of pages in this buffer pool.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferPool</span><span class="token punctuation">(</span><span class="token keyword">int</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numPages <span class="token operator">=</span> numPages<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pageCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>evict <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LRUEvict</span><span class="token punctuation">(</span>numPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lockManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LockManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> pageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setPageSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BufferPool</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> pageSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// THIS FUNCTION SHOULD ONLY BE USED FOR TESTING!!</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">resetPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BufferPool</span><span class="token punctuation">.</span>pageSize <span class="token operator">=</span> <span class="token constant">DEFAULT_PAGE_SIZE</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Retrieve the specified page with the associated permissions.
     * Will acquire a lock and may block if that lock is held by another
     * transaction.
     * &lt;p&gt;
     * The retrieved page should be looked up in the buffer pool.  If it
     * is present, it should be returned.  If it is not present, it should
     * be added to the buffer pool and returned.  If there is insufficient
     * space in the buffer pool, a page should be evicted and the new page
     * should be added in its place.
     *
     * @param tid the ID of the transaction requesting the page
     * @param pid the ID of the requested page
     * @param perm the requested permissions on the page
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">Page</span> <span class="token function">getPage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> pid<span class="token punctuation">,</span> <span class="token class-name">Permissions</span> perm<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> acquireType <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>perm <span class="token operator">==</span> <span class="token class-name">Permissions</span><span class="token punctuation">.</span><span class="token constant">READ_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            acquireType <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>lockManager<span class="token punctuation">.</span><span class="token function">acquireLock</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> acquireType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>now <span class="token operator">-</span> start <span class="token operator">&gt;</span> timeout<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pageCache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Page</span> page <span class="token operator">=</span> dbFile<span class="token punctuation">.</span><span class="token function">readPage</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            evict<span class="token punctuation">.</span><span class="token function">modifyData</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageCache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pageCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pageCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Releases the lock on a page.
     * Calling this is very risky, and may result in wrong behavior. Think hard
     * about who needs to call this and why, and why they can run the risk of
     * calling it.
     *
     * @param tid the ID of the transaction requesting the unlock
     * @param pid the ID of the page to unlock
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">unsafeReleasePage</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        lockManager<span class="token punctuation">.</span><span class="token function">releaseLock</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Release all locks associated with a given transaction.
     *
     * @param tid the ID of the transaction requesting the unlock
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transactionComplete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        lockManager<span class="token punctuation">.</span><span class="token function">completeTransaction</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">transactionComplete</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/** Return true if the specified transaction has a lock on the specified page */</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">holdsLock</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">PageId</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        <span class="token keyword">return</span> lockManager<span class="token punctuation">.</span><span class="token function">isHoldLock</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Commit or abort a given transaction; release all locks associated to
     * the transaction.
     *
     * @param tid the ID of the transaction requesting the unlock
     * @param commit a flag indicating whether we should commit or abort
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transactionComplete</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> commit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>commit<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">flushPages</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment">//从磁盘重新加载页</span>
            <span class="token function">recoverPages</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lockManager<span class="token punctuation">.</span><span class="token function">completeTransaction</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">recoverPages</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> m <span class="token operator">:</span> pageCache<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">PageId</span> pageId <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Page</span> page <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tid<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">int</span> tableId <span class="token operator">=</span> pageId<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Page</span> cleanPage <span class="token operator">=</span> dbFile<span class="token punctuation">.</span><span class="token function">readPage</span><span class="token punctuation">(</span>pageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                pageCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pageId<span class="token punctuation">,</span> cleanPage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a tuple to the specified table on behalf of transaction tid.  Will
     * acquire a write lock on the page the tuple is added to and any other
     * pages that are updated (Lock acquisition is not needed for lab2).
     * May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have
     * been dirtied to the cache (replacing any existing versions of those pages) so
     * that future requests see up-to-date pages.
     *
     * @param tid the transaction adding the tuple
     * @param tableId the table to add the tuple to
     * @param t the tuple to add
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token keyword">int</span> tableId<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">.</span><span class="token function">insertTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Remove the specified tuple from the buffer pool.
     * Will acquire a write lock on the page the tuple is removed from and any
     * other pages that are updated. May block if the lock(s) cannot be acquired.
     *
     * Marks any pages that were dirtied by the operation as dirty by calling
     * their markDirty bit, and adds versions of any pages that have
     * been dirtied to the cache (replacing any existing versions of those pages) so
     * that future requests see up-to-date pages.
     *
     * @param tid the transaction deleting the tuple.
     * @param t the tuple to delete
     */</span>
    <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">deleteTuple</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">,</span> <span class="token class-name">Tuple</span> t<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">DbException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">TransactionAbortedException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getRecordId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateBufferPool</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">.</span><span class="token function">deleteTuple</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateBufferPool</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> pages<span class="token punctuation">,</span> <span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Page</span> page <span class="token operator">:</span> pages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            page<span class="token punctuation">.</span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pageCache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> numPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            pageCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> page<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * Flush all dirty pages to disk.
     * NB: Be careful using this routine -- it writes dirty data to disk so will
     *     break simpledb if running in NO STEAL mode.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">flushAllPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> pageCache<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Page</span> page <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">flushPage</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Remove the specific page id from the buffer pool.
     Needed by the recovery manager to ensure that the
     buffer pool doesn't keep a rolled back page in its
     cache.

     Also used by B+ tree files to ensure that deleted pages
     are removed from the cache so they can be reused safely
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">discardPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        pageCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Flushes a certain page to disk
     * @param pid an ID indicating the page to flush
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">flushPage</span><span class="token punctuation">(</span><span class="token class-name">PageId</span> pid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">Page</span> flush <span class="token operator">=</span> pageCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过tableId找到对应的DbFile,并将page写入到对应的DbFile中</span>
        <span class="token keyword">int</span> tableId <span class="token operator">=</span> pid<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TransactionId</span> dirtier <span class="token operator">=</span> flush<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirtier <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logWrite</span><span class="token punctuation">(</span>dirtier<span class="token punctuation">,</span> flush<span class="token punctuation">.</span><span class="token function">getBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//调用force()方法是为了确保在页刷新到磁盘之前日志记录先记录到磁盘中</span>
            <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getLogFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将page刷新到磁盘</span>
        dbFile<span class="token punctuation">.</span><span class="token function">writePage</span><span class="token punctuation">(</span>flush<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flush<span class="token punctuation">.</span><span class="token function">markDirty</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/** Write all pages of the specified transaction to disk.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">flushPages</span><span class="token punctuation">(</span><span class="token class-name">TransactionId</span> tid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1|lab2</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PageId</span><span class="token punctuation">,</span> <span class="token class-name">Page</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> pageCache<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Page</span> page <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            page<span class="token punctuation">.</span><span class="token function">setBeforeImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> tid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">flushPage</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Discards a page from the buffer pool.
     * Flushes the page to disk to ensure dirty pages are updated on disk.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">synchronized</span>  <span class="token keyword">void</span> <span class="token function">evictPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token comment">// not necessary for lab1</span>
        <span class="token class-name">PageId</span> evictPageId <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">Page</span> page <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isAllDirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pageCache<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            evictPageId <span class="token operator">=</span> evict<span class="token punctuation">.</span><span class="token function">getEvictPageId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            page <span class="token operator">=</span> pageCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>evictPageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span><span class="token function">isDirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                evict<span class="token punctuation">.</span><span class="token function">modifyData</span><span class="token punctuation">(</span>evictPageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                isAllDirty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token function">discardPage</span><span class="token punctuation">(</span>evictPageId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isAllDirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DbException</span><span class="token punctuation">(</span><span class="token string">&quot;failed to evict page: all pages are either dirty&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br></div></div><p>完成练习之后，代码需要通过EvictionTest单元测试.</p> <h2 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h2> <p>lab2整体不难，好好阅读代码注释比较容易实现 .</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/VuePressBlog/项目/MIT6.830/lab1.html" class="prev">
          MIT数据库Lab1实验报告
        </a></span> <span class="next"><a href="/VuePressBlog/项目/MIT6.830/lab3.html">
          MIT数据库Lab3实验报告
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-2c0089e8><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_1、开始" class="sidebar-link reco-side-_1、开始" data-v-2c0089e8>1、开始</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_1-1实现提示" class="sidebar-link reco-side-_1-1实现提示" data-v-2c0089e8>1.1实现提示</a></li><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2、实验指导" class="sidebar-link reco-side-_2、实验指导" data-v-2c0089e8>2、实验指导</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2-1-filter-and-join" class="sidebar-link reco-side-_2-1-filter-and-join" data-v-2c0089e8>2.1 Filter and Join</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2-2-aggregates" class="sidebar-link reco-side-_2-2-aggregates" data-v-2c0089e8>2.2 Aggregates</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2-3-heapfile-mutability" class="sidebar-link reco-side-_2-3-heapfile-mutability" data-v-2c0089e8>2.3 HeapFile Mutability</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2-4-insertion-deletion" class="sidebar-link reco-side-_2-4-insertion-deletion" data-v-2c0089e8>2.4 Insertion &amp; deletion</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_2-5-page-eviction" class="sidebar-link reco-side-_2-5-page-eviction" data-v-2c0089e8>2.5 Page eviction</a></li><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab2.html#_3、总结" class="sidebar-link reco-side-_3、总结" data-v-2c0089e8>3、总结</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/VuePressBlog/assets/js/app.f42cc359.js" defer></script><script src="/VuePressBlog/assets/js/3.baa1ae3e.js" defer></script><script src="/VuePressBlog/assets/js/1.17eb7108.js" defer></script><script src="/VuePressBlog/assets/js/295.57924749.js" defer></script>
  </body>
</html>
