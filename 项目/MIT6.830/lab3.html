<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MIT数据库Lab3实验报告 | 清溪的博客</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/VuePressBlog/logo.png">
    <script language="javascript" type="text/javascript" src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script language="javascript" type="text/javascript" src="/VuePressBlog/js/MouseClickEffect.js"></script>
    <meta name="description" content="面向对象面向君，不负代码不负卿。">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="QingXi,博客,conimi,nico">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="preload" href="/VuePressBlog/assets/css/0.styles.9c388079.css" as="style"><link rel="preload" href="/VuePressBlog/assets/js/app.f42cc359.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/3.baa1ae3e.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/1.17eb7108.js" as="script"><link rel="preload" href="/VuePressBlog/assets/js/296.3422295d.js" as="script"><link rel="prefetch" href="/VuePressBlog/assets/js/10.5cde4a25.js"><link rel="prefetch" href="/VuePressBlog/assets/js/100.e8835302.js"><link rel="prefetch" href="/VuePressBlog/assets/js/101.4813f7c4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/102.f2d0070e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/103.d51d5e7b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/104.2c2e0a97.js"><link rel="prefetch" href="/VuePressBlog/assets/js/105.81d767bd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/106.84bc095e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/107.d38a913b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/108.fdd75af5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/109.6c8c1b80.js"><link rel="prefetch" href="/VuePressBlog/assets/js/11.9aa5edfb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/110.e3a005f8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/111.55e98135.js"><link rel="prefetch" href="/VuePressBlog/assets/js/112.72f7c7a6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/113.b4e28c57.js"><link rel="prefetch" href="/VuePressBlog/assets/js/114.cf2181a8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/115.1e83aaa0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/116.e10e2ee4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/117.b52ba16c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/118.d020bf92.js"><link rel="prefetch" href="/VuePressBlog/assets/js/119.08f665e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/12.60bc0f16.js"><link rel="prefetch" href="/VuePressBlog/assets/js/120.d01dd2b3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/121.31ea9879.js"><link rel="prefetch" href="/VuePressBlog/assets/js/122.84d94594.js"><link rel="prefetch" href="/VuePressBlog/assets/js/123.53a4b3d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/124.34960a24.js"><link rel="prefetch" href="/VuePressBlog/assets/js/125.b10668d4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/126.4727128f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/127.bd0444ac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/128.f13fb966.js"><link rel="prefetch" href="/VuePressBlog/assets/js/129.cd58c794.js"><link rel="prefetch" href="/VuePressBlog/assets/js/13.d19e71e7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/130.cb81ade2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/131.224e10c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/132.8e9935c7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/133.efb1e341.js"><link rel="prefetch" href="/VuePressBlog/assets/js/134.f0ae3784.js"><link rel="prefetch" href="/VuePressBlog/assets/js/135.ede58465.js"><link rel="prefetch" href="/VuePressBlog/assets/js/136.b61d3341.js"><link rel="prefetch" href="/VuePressBlog/assets/js/137.cec28cb5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/138.7a03caed.js"><link rel="prefetch" href="/VuePressBlog/assets/js/139.1e11c602.js"><link rel="prefetch" href="/VuePressBlog/assets/js/14.add2b9d1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/140.13501399.js"><link rel="prefetch" href="/VuePressBlog/assets/js/141.855e01a3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/142.d167685b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/143.e4099358.js"><link rel="prefetch" href="/VuePressBlog/assets/js/144.01aa96d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/145.0d7704dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/146.15a0c678.js"><link rel="prefetch" href="/VuePressBlog/assets/js/147.e4106bdb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/148.752aea80.js"><link rel="prefetch" href="/VuePressBlog/assets/js/149.63cc4679.js"><link rel="prefetch" href="/VuePressBlog/assets/js/15.a7aa72c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/150.a888b9db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/151.699fc7f2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/152.4e0a1d97.js"><link rel="prefetch" href="/VuePressBlog/assets/js/153.c06c2807.js"><link rel="prefetch" href="/VuePressBlog/assets/js/154.b5c8588a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/155.77e5eb1b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/156.113c82e4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/157.63bacdc9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/158.3f51e3c8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/159.4c3ab201.js"><link rel="prefetch" href="/VuePressBlog/assets/js/16.f8623d4d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/160.0643eed1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/161.aabff61f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/162.1683bd2a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/163.9dee0aec.js"><link rel="prefetch" href="/VuePressBlog/assets/js/164.eb5ed749.js"><link rel="prefetch" href="/VuePressBlog/assets/js/165.897998ac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/166.2ee105e0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/167.d7740ae3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/168.8f68baf6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/169.fe9fa913.js"><link rel="prefetch" href="/VuePressBlog/assets/js/17.610ee079.js"><link rel="prefetch" href="/VuePressBlog/assets/js/170.a8520244.js"><link rel="prefetch" href="/VuePressBlog/assets/js/171.21b14c12.js"><link rel="prefetch" href="/VuePressBlog/assets/js/172.10f99edd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/173.d7656598.js"><link rel="prefetch" href="/VuePressBlog/assets/js/174.7b9982df.js"><link rel="prefetch" href="/VuePressBlog/assets/js/175.99b01236.js"><link rel="prefetch" href="/VuePressBlog/assets/js/176.8ffef3ae.js"><link rel="prefetch" href="/VuePressBlog/assets/js/177.8b5872f1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/178.f8fc68ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/179.74a0b348.js"><link rel="prefetch" href="/VuePressBlog/assets/js/18.2e373db1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/180.81daf4e2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/181.01a6ef36.js"><link rel="prefetch" href="/VuePressBlog/assets/js/182.774dc5db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/183.d6ef8913.js"><link rel="prefetch" href="/VuePressBlog/assets/js/184.00862cd9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/185.b6894feb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/186.d1708cfc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/187.78b12cd6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/188.435b5abb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/189.c6ba7871.js"><link rel="prefetch" href="/VuePressBlog/assets/js/19.a9cebc54.js"><link rel="prefetch" href="/VuePressBlog/assets/js/190.2313d5c9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/191.7cbf852a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/192.cddbe224.js"><link rel="prefetch" href="/VuePressBlog/assets/js/193.77be9e07.js"><link rel="prefetch" href="/VuePressBlog/assets/js/194.9faf5142.js"><link rel="prefetch" href="/VuePressBlog/assets/js/195.6cadeeff.js"><link rel="prefetch" href="/VuePressBlog/assets/js/196.18a6b13c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/197.d5c76246.js"><link rel="prefetch" href="/VuePressBlog/assets/js/198.ba71e4cc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/199.8657a621.js"><link rel="prefetch" href="/VuePressBlog/assets/js/20.0f9cbebc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/200.3f21b610.js"><link rel="prefetch" href="/VuePressBlog/assets/js/201.2f13f56b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/202.1f2c89fd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/203.2595c2c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/204.a8191c75.js"><link rel="prefetch" href="/VuePressBlog/assets/js/205.5f3c94db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/206.2f8f2eab.js"><link rel="prefetch" href="/VuePressBlog/assets/js/207.bd13d97d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/208.8bf6932c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/209.ff286b0e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/21.c601bb2b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/210.f872f5b1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/211.cfe52e6b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/212.01e4bed2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/213.7871b223.js"><link rel="prefetch" href="/VuePressBlog/assets/js/214.0dbb3d93.js"><link rel="prefetch" href="/VuePressBlog/assets/js/215.f8499355.js"><link rel="prefetch" href="/VuePressBlog/assets/js/216.d5b75f04.js"><link rel="prefetch" href="/VuePressBlog/assets/js/217.bc9be9db.js"><link rel="prefetch" href="/VuePressBlog/assets/js/218.0a3d8a08.js"><link rel="prefetch" href="/VuePressBlog/assets/js/219.b90a5880.js"><link rel="prefetch" href="/VuePressBlog/assets/js/22.715a7176.js"><link rel="prefetch" href="/VuePressBlog/assets/js/220.538aadfa.js"><link rel="prefetch" href="/VuePressBlog/assets/js/221.8b556650.js"><link rel="prefetch" href="/VuePressBlog/assets/js/222.6ca7436f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/223.ee04d6bc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/224.c64cacac.js"><link rel="prefetch" href="/VuePressBlog/assets/js/225.6e3d044b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/226.13d32a7f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/227.b49aa5d2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/228.26422d49.js"><link rel="prefetch" href="/VuePressBlog/assets/js/229.3f590304.js"><link rel="prefetch" href="/VuePressBlog/assets/js/23.0df333c9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/230.b5f05cc3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/231.a123ac7b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/232.045132c3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/233.a38327cc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/234.3ff57bc3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/235.827c2ad3.js"><link rel="prefetch" href="/VuePressBlog/assets/js/236.bd5703d9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/237.c890a564.js"><link rel="prefetch" href="/VuePressBlog/assets/js/238.c4f28694.js"><link rel="prefetch" href="/VuePressBlog/assets/js/239.2bbfd7e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/24.039ee5f1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/240.84333a0d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/241.f9d6be5a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/242.b2fbffbe.js"><link rel="prefetch" href="/VuePressBlog/assets/js/243.4fee254c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/244.9a62ae23.js"><link rel="prefetch" href="/VuePressBlog/assets/js/245.b90c2426.js"><link rel="prefetch" href="/VuePressBlog/assets/js/246.5744a2d4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/247.5458c9bf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/248.d58a7106.js"><link rel="prefetch" href="/VuePressBlog/assets/js/249.ea10a59c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/25.0c24181f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/250.bb60e3c5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/251.3fa1c079.js"><link rel="prefetch" href="/VuePressBlog/assets/js/252.3c4921b2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/253.2fb57abe.js"><link rel="prefetch" href="/VuePressBlog/assets/js/254.4d32714a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/255.1701e9c6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/256.de4f48cf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/257.e3179f76.js"><link rel="prefetch" href="/VuePressBlog/assets/js/258.f2eed53d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/259.6b76ae85.js"><link rel="prefetch" href="/VuePressBlog/assets/js/26.6a162497.js"><link rel="prefetch" href="/VuePressBlog/assets/js/260.d280a827.js"><link rel="prefetch" href="/VuePressBlog/assets/js/261.3c5a0923.js"><link rel="prefetch" href="/VuePressBlog/assets/js/262.567dd288.js"><link rel="prefetch" href="/VuePressBlog/assets/js/263.9e44df73.js"><link rel="prefetch" href="/VuePressBlog/assets/js/264.a0956551.js"><link rel="prefetch" href="/VuePressBlog/assets/js/265.b718532c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/266.706cb10b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/267.3e34d2c7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/268.208628c4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/269.5a05a7c1.js"><link rel="prefetch" href="/VuePressBlog/assets/js/27.671023ee.js"><link rel="prefetch" href="/VuePressBlog/assets/js/270.5598a9ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/271.6e93da05.js"><link rel="prefetch" href="/VuePressBlog/assets/js/272.90e59ecb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/273.38adede7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/274.b1e5e4b5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/275.abe0b794.js"><link rel="prefetch" href="/VuePressBlog/assets/js/276.eeb46ffd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/277.25d075be.js"><link rel="prefetch" href="/VuePressBlog/assets/js/278.44d14db9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/279.78bf4c9c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/28.037ed440.js"><link rel="prefetch" href="/VuePressBlog/assets/js/280.1922e347.js"><link rel="prefetch" href="/VuePressBlog/assets/js/281.9ec656d8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/282.3e712165.js"><link rel="prefetch" href="/VuePressBlog/assets/js/283.022a227c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/284.2f332785.js"><link rel="prefetch" href="/VuePressBlog/assets/js/285.438e22f5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/286.51955bfa.js"><link rel="prefetch" href="/VuePressBlog/assets/js/287.b4085831.js"><link rel="prefetch" href="/VuePressBlog/assets/js/288.5a2658cb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/289.058dc59b.js"><link rel="prefetch" href="/VuePressBlog/assets/js/29.e52a9d90.js"><link rel="prefetch" href="/VuePressBlog/assets/js/290.eff2d159.js"><link rel="prefetch" href="/VuePressBlog/assets/js/291.ad38ea49.js"><link rel="prefetch" href="/VuePressBlog/assets/js/292.19cfeb16.js"><link rel="prefetch" href="/VuePressBlog/assets/js/293.6feeacae.js"><link rel="prefetch" href="/VuePressBlog/assets/js/294.d9533826.js"><link rel="prefetch" href="/VuePressBlog/assets/js/295.57924749.js"><link rel="prefetch" href="/VuePressBlog/assets/js/297.b2ec8551.js"><link rel="prefetch" href="/VuePressBlog/assets/js/298.99dd412a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/299.27c9cfcf.js"><link rel="prefetch" href="/VuePressBlog/assets/js/30.9d5b3ef4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/300.144b0c04.js"><link rel="prefetch" href="/VuePressBlog/assets/js/301.3071d48c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/302.651526dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/303.b350ada5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/304.68aa14e6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/305.533e903e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/306.43d3a3cd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/307.dd003bbc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/308.a9600cd4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/309.98357284.js"><link rel="prefetch" href="/VuePressBlog/assets/js/31.1cc30d4f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/310.af64ad9c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/311.aee170c5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/312.9a00d6c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/32.460d68ef.js"><link rel="prefetch" href="/VuePressBlog/assets/js/33.80f2039a.js"><link rel="prefetch" href="/VuePressBlog/assets/js/34.f573e1fb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/35.fc195065.js"><link rel="prefetch" href="/VuePressBlog/assets/js/36.03edaa74.js"><link rel="prefetch" href="/VuePressBlog/assets/js/37.6170733e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/38.4e800202.js"><link rel="prefetch" href="/VuePressBlog/assets/js/39.08c0ec17.js"><link rel="prefetch" href="/VuePressBlog/assets/js/4.10543b34.js"><link rel="prefetch" href="/VuePressBlog/assets/js/40.f6d02ad2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/41.6b527226.js"><link rel="prefetch" href="/VuePressBlog/assets/js/42.b6db7c15.js"><link rel="prefetch" href="/VuePressBlog/assets/js/43.1c8dc528.js"><link rel="prefetch" href="/VuePressBlog/assets/js/44.3feac64e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/45.72f2dd5e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/46.1b3b5f62.js"><link rel="prefetch" href="/VuePressBlog/assets/js/47.3e894961.js"><link rel="prefetch" href="/VuePressBlog/assets/js/48.acca312d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/49.fc79094c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/5.d0f450bd.js"><link rel="prefetch" href="/VuePressBlog/assets/js/50.4d8f01e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/51.c36c9269.js"><link rel="prefetch" href="/VuePressBlog/assets/js/52.2d3bf96c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/53.002fa1bb.js"><link rel="prefetch" href="/VuePressBlog/assets/js/54.5ba094ff.js"><link rel="prefetch" href="/VuePressBlog/assets/js/55.ee846bd2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/56.d29d1bad.js"><link rel="prefetch" href="/VuePressBlog/assets/js/57.2fd125e5.js"><link rel="prefetch" href="/VuePressBlog/assets/js/58.a0f9d4e9.js"><link rel="prefetch" href="/VuePressBlog/assets/js/59.4bddbee6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/6.24060e60.js"><link rel="prefetch" href="/VuePressBlog/assets/js/60.7bd2fd4c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/61.d1ba9295.js"><link rel="prefetch" href="/VuePressBlog/assets/js/62.77818eb4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/63.37359d58.js"><link rel="prefetch" href="/VuePressBlog/assets/js/64.9419cd75.js"><link rel="prefetch" href="/VuePressBlog/assets/js/65.ef2a03a2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/66.ec148097.js"><link rel="prefetch" href="/VuePressBlog/assets/js/67.70adf0f4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/68.9edae7ec.js"><link rel="prefetch" href="/VuePressBlog/assets/js/69.a282d9f8.js"><link rel="prefetch" href="/VuePressBlog/assets/js/7.b8bf6b3f.js"><link rel="prefetch" href="/VuePressBlog/assets/js/70.9da04b45.js"><link rel="prefetch" href="/VuePressBlog/assets/js/71.e66347dc.js"><link rel="prefetch" href="/VuePressBlog/assets/js/72.35386d60.js"><link rel="prefetch" href="/VuePressBlog/assets/js/73.3ae48352.js"><link rel="prefetch" href="/VuePressBlog/assets/js/74.aa533041.js"><link rel="prefetch" href="/VuePressBlog/assets/js/75.c365f351.js"><link rel="prefetch" href="/VuePressBlog/assets/js/76.e3fa8430.js"><link rel="prefetch" href="/VuePressBlog/assets/js/77.709bb6a4.js"><link rel="prefetch" href="/VuePressBlog/assets/js/78.aa043416.js"><link rel="prefetch" href="/VuePressBlog/assets/js/79.ac9ff67d.js"><link rel="prefetch" href="/VuePressBlog/assets/js/8.024a3703.js"><link rel="prefetch" href="/VuePressBlog/assets/js/80.aeb25e4e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/81.c83cd55c.js"><link rel="prefetch" href="/VuePressBlog/assets/js/82.7d6d1162.js"><link rel="prefetch" href="/VuePressBlog/assets/js/83.da5d7007.js"><link rel="prefetch" href="/VuePressBlog/assets/js/84.45020071.js"><link rel="prefetch" href="/VuePressBlog/assets/js/85.d00e8c23.js"><link rel="prefetch" href="/VuePressBlog/assets/js/86.34b47188.js"><link rel="prefetch" href="/VuePressBlog/assets/js/87.8b6d49ab.js"><link rel="prefetch" href="/VuePressBlog/assets/js/88.278b18a6.js"><link rel="prefetch" href="/VuePressBlog/assets/js/89.99e94d6e.js"><link rel="prefetch" href="/VuePressBlog/assets/js/9.d630a5e2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/90.f0f914d7.js"><link rel="prefetch" href="/VuePressBlog/assets/js/91.ee4fa553.js"><link rel="prefetch" href="/VuePressBlog/assets/js/92.b7f22909.js"><link rel="prefetch" href="/VuePressBlog/assets/js/93.c74fb8c2.js"><link rel="prefetch" href="/VuePressBlog/assets/js/94.e9d25630.js"><link rel="prefetch" href="/VuePressBlog/assets/js/95.bf8f1e37.js"><link rel="prefetch" href="/VuePressBlog/assets/js/96.9ccbbd24.js"><link rel="prefetch" href="/VuePressBlog/assets/js/97.73707f37.js"><link rel="prefetch" href="/VuePressBlog/assets/js/98.ce525fd0.js"><link rel="prefetch" href="/VuePressBlog/assets/js/99.c45e5fab.js">
    <link rel="stylesheet" href="/VuePressBlog/assets/css/0.styles.9c388079.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-11f94078><div data-v-11f94078><div class="password-shadow password-wrapper-out" style="display:none;" data-v-08f61db9 data-v-11f94078 data-v-11f94078><h3 class="title" data-v-08f61db9>清溪的博客</h3> <p class="description" data-v-08f61db9>面向对象面向君，不负代码不负卿。</p> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>QingXi</span>
          
        <span data-v-08f61db9>2022 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-11f94078><header class="navbar" data-v-11f94078><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/VuePressBlog/" class="home-link router-link-active"><img src="/VuePressBlog/logo.png" alt="清溪的博客" class="logo"> <span class="site-name">清溪的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/VuePressBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/VuePressBlog/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/VuePressBlog/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-11f94078></div> <aside class="sidebar" data-v-11f94078><div class="personal-info-wrapper" data-v-3d87d2e4 data-v-11f94078><img src="/VuePressBlog/logo.png" alt="author-avatar" class="personal-img" data-v-3d87d2e4> <h3 class="name" data-v-3d87d2e4>
    QingXi
  </h3> <div class="num" data-v-3d87d2e4><div data-v-3d87d2e4><h3 data-v-3d87d2e4>74</h3> <h6 data-v-3d87d2e4>文章</h6></div> <div data-v-3d87d2e4><h3 data-v-3d87d2e4>29</h3> <h6 data-v-3d87d2e4>标签</h6></div></div> <ul class="social-links" data-v-3d87d2e4></ul> <hr data-v-3d87d2e4></div> <nav class="nav-links"><div class="nav-item"><a href="/VuePressBlog/" class="nav-link"><i class="iconfont reco-home"></i>
  随性一点的主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/随笔/me.html" class="nav-link"><i class="undefined"></i>
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/面经/" class="nav-link"><i class="undefined"></i>
  面经
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/network/浏览器输入url过程.html" class="nav-link"><i class="undefined"></i>
  计算机网络
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Os/段式存储和页式存储.html" class="nav-link"><i class="undefined"></i>
  操作系统
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/中间件/" class="nav-link"><i class="undefined"></i>
  中间件
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Java-框架/" class="nav-link"><i class="undefined"></i>
  Java框架
</a></li><li class="dropdown-item"><!----> <a href="/VuePressBlog/Linux/常见面试题.html" class="nav-link"><i class="undefined"></i>
  Linux
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  随笔标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      项目
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>底层项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.830 JAVA
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.s081 C
</a></li><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  MIT6.824 GO
</a></li></ul></li><li class="dropdown-item"><h4>游戏项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  AI对抗平台 JAVA
</a></li></ul></li><li class="dropdown-item"><h4>合作项目</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/VuePressBlog/项目/" class="nav-link"><i class="undefined"></i>
  仿北邮人论坛 JAVA
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      算法
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/LeetCode/" class="nav-link"><i class="undefined"></i>
  算法
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-document"></i>
      人工智能
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/VuePressBlog/论文/" class="nav-link"><i class="undefined"></i>
  漏洞检测
</a></li></ul></div></div><div class="nav-item"><a href="/VuePressBlog/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  归档
</a></div><div class="nav-item"><a href="/VuePressBlog/review.html" class="nav-link"><i class="iconfont reco-blog"></i>
  回顾
</a></div><div class="nav-item"><a href="/VuePressBlog/aboutme.html" class="nav-link"><i class="iconfont reco-account"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MIT项目</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>MIT数据库</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/VuePressBlog/项目/MIT6.830/lab1.html" class="sidebar-link">MIT数据库Lab1实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab2.html" class="sidebar-link">MIT数据库Lab2实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab3.html" class="active sidebar-link">MIT数据库Lab3实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab4.html" class="sidebar-link">MIT数据库Lab4实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab5.html" class="sidebar-link">MIT数据库Lab5实验报告</a></li><li><a href="/VuePressBlog/项目/MIT6.830/lab6.html" class="sidebar-link">MIT数据库Lab6实验报告</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT操作系统</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>MIT分布式系统</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>游戏项目</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>精准问答系统</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-08f61db9 data-v-11f94078><h3 class="title" data-v-08f61db9>MIT数据库Lab3实验报告</h3> <!----> <label id="box" class="inputBox" data-v-08f61db9><input type="password" value="" data-v-08f61db9> <span data-v-08f61db9>Konck! Knock!</span> <button data-v-08f61db9>OK</button></label> <div class="footer" data-v-08f61db9><span data-v-08f61db9><i class="iconfont reco-theme" data-v-08f61db9></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-08f61db9>vuePress-theme-reco</a></span> <span data-v-08f61db9><i class="iconfont reco-copyright" data-v-08f61db9></i> <a data-v-08f61db9><span data-v-08f61db9>QingXi</span>
          
        <span data-v-08f61db9>2022 - </span>
        2023
      </a></span></div></div> <div data-v-11f94078><div data-v-11f94078><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">MIT数据库Lab3实验报告</h1> <div data-v-162cc157><i class="iconfont reco-account" data-v-162cc157><span data-v-162cc157>QingXi</span></i> <!----> <i class="iconfont reco-eye" data-v-162cc157><span id="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-162cc157><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <!----></div></div> <div class="theme-reco-content content__default"><h2 id="_1、开始"><a href="#_1、开始" class="header-anchor">#</a> 1、开始</h2> <p>我们应该在lab2的基础上进行开发，完成lab3的练习</p> <h3 id="_1-1-实现提示"><a href="#_1-1-实现提示" class="header-anchor">#</a> 1.1 实现提示</h3> <p>建议跟着文档的练习来实现对应的代码，通读整篇文档的实验后也可能发现更加合适的代码实现顺序</p> <p>下面是本实验的大纲：</p> <ul><li>实现TableStats类中的方法，通过直方图(IntHistogram类)或者设计其他统计方法，使TableStats能够估计filter和scan的可选择性</li> <li>实现JoinOptimizer类中的方法，允许通过它估计join操作的开销以及可选择性</li> <li>实现JoinOptimizer的orderJoins方法；该方法为一系列连接生成最佳的顺序，前提是在前两个步骤中计算的统计信息</li></ul> <h2 id="_2、优化大纲"><a href="#_2、优化大纲" class="header-anchor">#</a> 2、优化大纲</h2> <p>回忆基于成本的优化策略：</p> <ul><li>使用表的统计数据估计不同查询计划的花费；通常，计划的成本与中间连接和选择的基数(生成的元组的数量)以及筛选器和连接谓词的选择性有关</li> <li>通过这些统计数据以最优的方式排序连接和选择操作，并从多个备选方案中为连接算法选择最佳实现</li></ul> <p>在本次实验，我们将会通过代码实现这些功能</p> <p>优化器将会被simpledb/Parser.java类中的方法调用。可以去lab2中查看它的使用方法</p> <p>当Parser被调用时，它会计算所有表的统计信息(通过我们实现的统计方法)。当查询被提交，解析器将会将查询转换为逻辑计划并且调用我们提供的查询优化器以生成最优的执行计划。</p> <h3 id="_2-1-优化器全貌"><a href="#_2-1-优化器全貌" class="header-anchor">#</a> 2.1 优化器全貌</h3> <p>在开始实验之前，我们需要理解SimpleDB优化器的整体结构，解析器和优化器的SimpleDB模块的总体控制流如下图所示：</p> <p><img src="https://img-blog.csdnimg.cn/50fbd945d3164877acc6222ee7eb562e.png" alt="在这里插入图片描述"></p> <p>该图表示了解析器使用的类、方法和对象。类和方法的将会在接下来的文章进行详细的解释，基本的操作如下：</p> <ul><li>Parser.java初始化时构造了表统计数据的集合(存储在statsMap容器中)，它接下来就等待输入查询，并调用查询的parseQuery方法</li> <li>parseQuery首先构造代表已经解析的查询LogicalPlan类，并且调用LogicalPlan实例的physicalPlan方法，该方法会返回可以用于实际查询的DBIterator对象</li></ul> <p>在接下来的练习中，我们实现的方法将会协助physicalPlan创造出最优的查询计划.</p> <h3 id="_2-2-统计数据估计法"><a href="#_2-2-统计数据估计法" class="header-anchor">#</a> 2.2 统计数据估计法</h3> <p>精确估计查询计划的成本非常困难，在本次实验，我们仅关注连接和基于表访问的成本，我们不关心访问方法的选择性(因为我们只有table scans一个访问方法)或额外操作的成本(例如聚合操作)</p> <h4 id="_2-2-1-计划成本"><a href="#_2-2-1-计划成本" class="header-anchor">#</a> 2.2.1 计划成本</h4> <p>假设连接计划的形式如下：<code>p = t1 join t2 join ... tn</code>，给出类似于p的查询计划，它的成本可以这样计算：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>scancost(t1) + scancost(t2) + joincost(t1 join t2) +
scancost(t3) + joincost((t1 join t2) join t3) +
... 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>scancost(t1)是扫描表t1的I/O开销，joincost(t1, t2)是连接t1和t2的CPU开销，为了使I/O和CPU成本具有可比性，通常使用一个恒定的比例因子，例如：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>cost(predicate application) = 1
cost(pageScan) = SCALING_FACTOR x cost(predicate application)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>在本次实验中，我们可以忽略缓存的影响(假设每次访问表都需要扫描文件)，因此，scancost(t1)的结果就简单描述为页面的数量<code>t1 x SCALING_FACTOR</code></p> <h4 id="_2-2-2-连接成本"><a href="#_2-2-2-连接成本" class="header-anchor">#</a> 2.2.2 连接成本</h4> <p>当使用嵌套循环连接时，连接表t1和t2的成本可以简单的表示为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>joincost(t1 join t2) = scancost(t1) + ntups(t1) x scancost(t2) //IOcost
                       + ntups(t1) x ntups(t2)  //CPUcost
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>ntups(t1)是表t1的元组数量</p> <h4 id="_2-2-3-可选择性"><a href="#_2-2-3-可选择性" class="header-anchor">#</a> 2.2.3 可选择性</h4> <p>可以通过扫描表计算ntups，评估带有一个或多个选择谓词的表的设置可能比较棘手–这就是筛选器选择性估计问题。下面是你可能使用的估计可选择性的方法之一，通过计算表中包含的值的直方图实现：</p> <ul><li><p>计算表中每个属性的最大值和最小值(通过一次扫描实现)</p></li> <li><p>对表中的每个属性构造一个柱状图。一种简单的方法如下：使用固定数量的桶，其中每个桶表示直方图属性域的固定范围内的记录数量</p> <p>例如，如果字段f的范围是1到100，并且有10个bucket，那么bucket 1可能就包含1到10之间的记录数，bucket 2包含第11到20之间的记录数，以此类推</p></li> <li><p>再次扫描表，选择所有元组的所有字段，并且使用它们填充每个直方图中的桶计数</p></li> <li><p>为了评估等价表达式的选择性，f = const，计算包含const值的bucket的值</p> <p>假设bucket的宽度(值的范围)为w，高度(元组的数量)为h，并且表中元组的数量为ntups</p> <p>假设值在整个桶中均匀分布，那么表达式的可选择性大约为：(h/w) / ntups</p> <p>其中h/w代表值为const的容器中元组的预期数目</p></li> <li><p>为了评估范围表达式f &gt; const的可选择性</p> <p>计算const所在bucket的值b，得到宽度w_b和高度h_b</p> <p>然后b就包含了整个元组的一个分数 b_f = h_b / ntups</p> <p>假设元组在b中均匀分布，分数b_part即 &gt; const, 为</p> <p>(b_right-const)/w_b；其中b_right是bucket的右端点</p> <p>因此，bucket b 为谓词提供了 b_f x b_part的可选择性</p> <p>此外，bucket b+1 … NumB-1提供了所有的可选择性(可以用上面类似于b_f的公式计算)</p> <p>求和所有桶的选择性贡献将得到表达式的总体选择性</p> <p>下图展示了这一过程：</p></li></ul> <p><img src="https://img-blog.csdnimg.cn/760205fb146448e3920eb1573b3a6b9e.png" alt="在这里插入图片描述"></p> <ul><li>涉及小于的表达式的可选择性可以执行类似于大于的情况，直接求和const左侧的桶的可选择性(类比图)</li></ul> <p>在接下来的两个练习中，我们将编写代码来执行连接和过滤器的选择性估计.</p> <p><strong>练习1: IntHistogram</strong></p> <p>为了估计可选择性，你需要实现一些方法去记录了表的统计信息，源码中已经提供了框架类：<code>IntHistogram</code>，我们的目是通过上面描述的基于bucket的思想计算统计直方图，但是只要可以进行合理的可选择性估计使用其他方法也可</p> <p>源码中提供了基于<code>IntHistogram</code>的 <code>StringHistogram</code>类以计算String谓词的可选择性，如果我们有更好的评估器，我们可以修改StringHistogram的实现，否则无需变动该类</p> <p>通过单元测试IntHistogramTest代码即代表完成该练习.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>optimizer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Permissions</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>execution<span class="token punctuation">.</span></span><span class="token class-name">Predicate</span></span><span class="token punctuation">;</span>

<span class="token comment">/** A class to represent a fixed-width histogram over a single integer-based field.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntHistogram</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 存储柱状图
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> histogram<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 柱状图bucket数量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> buckets<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> min<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> max<span class="token punctuation">;</span>
    <span class="token comment">//bucket宽度</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> width<span class="token punctuation">;</span>
    <span class="token comment">//元组总数</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> ntups<span class="token punctuation">;</span>
    <span class="token comment">/**
     * Create a new IntHistogram.
     * 
     * This IntHistogram should maintain a histogram of integer values that it receives.
     * It should split the histogram into &quot;buckets&quot; buckets.
     * 
     * The values that are being histogrammed will be provided one-at-a-time through the &quot;addValue()&quot; function.
     * 
     * Your implementation should use space and have execution time that are both
     * constant with respect to the number of values being histogrammed.  For example, you shouldn't 
     * simply store every value that you see in a sorted list.
     * 
     * @param buckets The number of buckets to split the input value into.
     * @param min The minimum integer value that will ever be passed to this class for histogramming
     * @param max The maximum integer value that will ever be passed to this class for histogramming
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">IntHistogram</span><span class="token punctuation">(</span><span class="token keyword">int</span> buckets<span class="token punctuation">,</span> <span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>buckets <span class="token operator">=</span> buckets<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>max <span class="token operator">=</span> max<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>min <span class="token operator">=</span> min<span class="token punctuation">;</span>
        <span class="token comment">//通过buckets、min&amp;max计算每个桶的weight</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">/</span> buckets<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>histogram <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>buckets<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ntups <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Add a value to the set of values that you are keeping a histogram of.
     * @param v Value to add to the histogram
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addValue</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// some code goes here</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        histogram<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
        ntups<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">&gt;</span> max <span class="token operator">||</span> v <span class="token operator">&lt;</span> min<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;value out of range&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> v <span class="token operator">==</span> max <span class="token operator">?</span> <span class="token punctuation">(</span>buckets <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>v <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">/</span> width<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Estimate the selectivity of a particular predicate and operand on this table.
     * 
     * For example, if &quot;op&quot; is &quot;GREATER_THAN&quot; and &quot;v&quot; is 5, 
     * return your estimate of the fraction of elements that are greater than 5.
     * 
     * @param op Operator
     * @param v Value
     * @return Predicted selectivity of this particular operator and value
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//可选择性</span>
    	<span class="token comment">// some code goes here</span>
        <span class="token keyword">double</span> selectivity <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">LESS_THAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//&lt;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">&lt;=</span> min<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">&gt;</span> max<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">getIndex</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// b_part = (b_right - const) / w_b</span>
            <span class="token comment">// b_f = h_b / ntups</span>
            <span class="token comment">// selectivity = b_f * b_part</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> index<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                selectivity <span class="token operator">+=</span> <span class="token punctuation">(</span>histogram<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> ntups<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//均匀分布,可以看成先除以width得到一份,v-b_left份</span>
            <span class="token keyword">double</span> b_part <span class="token operator">=</span> <span class="token punctuation">(</span>v <span class="token operator">-</span> index <span class="token operator">*</span> width <span class="token operator">-</span> min<span class="token punctuation">)</span> <span class="token operator">/</span> width<span class="token punctuation">;</span>
            <span class="token keyword">double</span> b_f <span class="token operator">=</span> histogram<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">/</span> ntups<span class="token punctuation">;</span>
            selectivity <span class="token operator">+=</span> b_f <span class="token operator">*</span> b_part<span class="token punctuation">;</span>
            <span class="token keyword">return</span> selectivity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">EQUALS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>v <span class="token operator">&lt;</span> min <span class="token operator">||</span> v <span class="token operator">&gt;</span> max<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 这里width+1是为了确保selectivity的范围在(0,1)之间</span>
            <span class="token comment">// (h / w) / ntups</span>
            <span class="token keyword">return</span> <span class="token number">1.0</span> <span class="token operator">*</span> histogram<span class="token punctuation">[</span><span class="token function">getIndex</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>width <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> ntups<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">GREATER_THAN</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//&gt;</span>
            <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">LESS_THAN_OR_EQ</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">LESS_THAN_OR_EQ</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">LESS_THAN</span><span class="token punctuation">,</span> v <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">GREATER_THAN_OR_EQ</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">GREATER_THAN</span><span class="token punctuation">,</span> v <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">NOT_EQUALS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">EQUALS</span><span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @return
     *     the average selectivity of this histogram.
     *     
     *     This is not an indispensable method to implement the basic
     *     join optimization. It may be needed if you want to
     *     implement a more efficient optimization
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">avgSelectivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">double</span> avg <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buckets<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            avg <span class="token operator">+=</span> <span class="token punctuation">(</span>histogram<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> ntups<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> avg<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/**
     * @return A string describing this histogram, for debugging purposes
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> histogram<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">double</span> l <span class="token operator">=</span> i <span class="token operator">*</span> width<span class="token punctuation">;</span>
            <span class="token keyword">double</span> r <span class="token operator">=</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> width<span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;[%f, %f]:%d\n&quot;</span><span class="token punctuation">,</span> l<span class="token punctuation">,</span> r<span class="token punctuation">,</span> histogram<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br></div></div><p>理解了上面讲述的基于直方图的可选择性估计方法，很容易实现该类</p> <p><strong>练习2：TableStats</strong></p> <p>TableStats类中包含计算表中页和元组数量以及估计表中每个属性的可选择性的方法。查询解析器已经为每张表创建了一个TableStats实例，并且将其传递给了你的查询优化器</p> <p>我们应该实现TableStats中的如下方法：</p> <ul><li>实现TableStats构造方法：编写扫描表的代码创建我们需要的统计数据；这里要多次扫描表，一次统计表中某属性的最大最小值，一次构造Histogram</li> <li>实现<code>estimateSelectivity(int field, Predicate.Op op,Field constant)</code>:通过我们自己实现的统计数据(IntHistogram or StringHistogram),估计表中对应谓词的可选择性</li> <li>实现estimateScanCost()方法：该方法估计顺序扫描文件的成本，读取页的成本为<code>costPerPageIO</code>，我们可以假设没有寻找耗时并且bufferpool中不存在页。此方法可能使用在构造函数中计算的开销或大小</li> <li>实现estimateTableCardinality(double selectivityFactor)方法：如果应用了带有选择性selectivityFactor的谓词，该方法将返回关系中元组的数量</li></ul> <p>通过TableStatsTest代表完成该练习。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>optimizer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">DbException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Type</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>execution<span class="token punctuation">.</span></span><span class="token class-name">Predicate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>execution<span class="token punctuation">.</span></span><span class="token class-name">SeqScan</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionAbortedException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span></span><span class="token class-name">TransactionId</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentMap</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * TableStats represents statistics (e.g., histograms) about base tables in a
 * query.
 *
 * This class is not needed in implementing lab1 and lab2.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TableStats</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> statsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">IOCOSTPERPAGE</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">TableStats</span> <span class="token function">getTableStats</span><span class="token punctuation">(</span><span class="token class-name">String</span> tablename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> statsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tablename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTableStats</span><span class="token punctuation">(</span><span class="token class-name">String</span> tablename<span class="token punctuation">,</span> <span class="token class-name">TableStats</span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        statsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>tablename<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setStatsMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> s<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Field</span> statsMapF <span class="token operator">=</span> <span class="token class-name">TableStats</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;statsMap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            statsMapF<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            statsMapF<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchFieldException</span> <span class="token operator">|</span> <span class="token class-name">IllegalAccessException</span> <span class="token operator">|</span> <span class="token class-name">IllegalArgumentException</span> <span class="token operator">|</span> <span class="token class-name">SecurityException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> <span class="token function">getStatsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> statsMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">computeStatistics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> tableIt <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tableIdIterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Computing table stats.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tableIt<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> tableid <span class="token operator">=</span> tableIt<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TableStats</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TableStats</span><span class="token punctuation">(</span>tableid<span class="token punctuation">,</span> <span class="token constant">IOCOSTPERPAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTableStats</span><span class="token punctuation">(</span><span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>tableid<span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Done.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Number of bins for the histogram. Feel free to increase this value over
     * 100, though our tests assume that you have at least 100 bins in your
     * histograms.
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NUM_HIST_BINS</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> tableid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> ioCostPerPage<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 记录表中每个属性的Histogram
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">IntHistogram</span><span class="token punctuation">&gt;</span></span> intHistogramMap<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">StringHistogram</span><span class="token punctuation">&gt;</span></span> stringHistogramMap<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表对应的page数量
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> numPage<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 表的详细信息
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">TupleDesc</span> tupleDesc<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 表中的元组数
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> totalTuples<span class="token punctuation">;</span>


    <span class="token comment">/**
     * Create a new TableStats object, that keeps track of statistics on each
     * column of a table
     *
     * @param tableid
     *            The table over which to compute statistics
     * @param ioCostPerPage
     *            The cost per page of IO. This doesn't differentiate between
     *            sequential-scan IO and disk seeks.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">TableStats</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">,</span> <span class="token keyword">int</span> ioCostPerPage<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// For this function, you'll have to get the</span>
        <span class="token comment">// DbFile for the table in question,</span>
        <span class="token comment">// then scan through its tuples and calculate</span>
        <span class="token comment">// the values that you need.</span>
        <span class="token comment">// You should try to do this reasonably efficiently, but you don't</span>
        <span class="token comment">// necessarily have to (for example) do everything</span>
        <span class="token comment">// in a single scan of the table.</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tableid <span class="token operator">=</span> tableid<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ioCostPerPage <span class="token operator">=</span> ioCostPerPage<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalTuples <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">DbFile</span> dbFile <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDatabaseFile</span><span class="token punctuation">(</span>tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>numPage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HeapFile</span><span class="token punctuation">)</span>dbFile<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">numPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tupleDesc <span class="token operator">=</span> dbFile<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>intHistogramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stringHistogramMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token function">initHistogram</span><span class="token punctuation">(</span>tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initHistogram</span><span class="token punctuation">(</span><span class="token keyword">int</span> tableid<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">TransactionAbortedException</span><span class="token punctuation">,</span> <span class="token class-name">DbException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 第一次遍历，找到最大最小值</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> tupleDesc<span class="token punctuation">.</span><span class="token function">numFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TransactionId</span> tid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SeqScan</span> seqScan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SeqScan</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> tableid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        seqScan<span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> minMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> maxMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>seqScan<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> seqScan<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            totalTuples<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">IntField</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Integer</span> minVal <span class="token operator">=</span> minMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    minMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>minVal<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">Integer</span> maxVal <span class="token operator">=</span> maxMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    maxMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxVal<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">StringHistogram</span> histogram <span class="token operator">=</span> stringHistogramMap<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StringHistogram</span><span class="token punctuation">(</span><span class="token constant">NUM_HIST_BINS</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">StringField</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">StringField</span><span class="token punctuation">)</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    histogram<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    stringHistogramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> histogram<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 先实例化每列的Histogram</span>
        <span class="token comment">// 每列的histogram</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>minMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Integer</span> min <span class="token operator">=</span> minMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Integer</span> max <span class="token operator">=</span> maxMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                intHistogramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">IntHistogram</span><span class="token punctuation">(</span><span class="token constant">NUM_HIST_BINS</span><span class="token punctuation">,</span> min<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 第二次遍历,记录每列的Histogram</span>
        seqScan<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>seqScan<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Tuple</span> tuple <span class="token operator">=</span> seqScan<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">IntField</span> field <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span> tuple<span class="token punctuation">.</span><span class="token function">getField</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">IntHistogram</span> intHistogram <span class="token operator">=</span> intHistogramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>intHistogram <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    intHistogram<span class="token punctuation">.</span><span class="token function">addValue</span><span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    intHistogramMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> intHistogram<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        seqScan<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * Estimates the cost of sequentially scanning the file, given that the cost
     * to read a page is costPerPageIO. You can assume that there are no seeks
     * and that no pages are in the buffer pool.
     *
     * Also, assume that your hard drive can only read entire pages at once, so
     * if the last page of the table only has one tuple on it, it's just as
     * expensive to read as a full page. (Most real hard drives can't
     * efficiently address regions smaller than a page at a time.)
     *
     * @return The estimated cost of scanning the table.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> numPage <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">*</span> ioCostPerPage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * This method returns the number of tuples in the relation, given that a
     * predicate with selectivity selectivityFactor is applied.
     *
     * @param selectivityFactor
     *            The selectivity of any predicates over the table
     * @return The estimated cardinality of the scan with the specified
     *         selectivityFactor
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span><span class="token keyword">double</span> selectivityFactor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>totalTuples <span class="token operator">*</span> selectivityFactor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * The average selectivity of the field under op.
     * @param field
     *        the index of the field
     * @param op
     *        the operator in the predicate
     * The semantic of the method is that, given the table, and then given a
     * tuple, of which we do not know the value of the field, return the
     * expected selectivity. You may estimate this value from the histograms.
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">avgSelectivity</span><span class="token punctuation">(</span><span class="token keyword">int</span> field<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> intHistogramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avgSelectivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> stringHistogramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avgSelectivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Estimate the selectivity of predicate &lt;tt&gt;field op constant&lt;/tt&gt; on the
     * table.
     *
     * @param field
     *            The field over which the predicate ranges
     * @param op
     *            The logical operation in the predicate
     * @param constant
     *            The value against which the field is compared
     * @return The estimated selectivity (fraction of tuples that satisfy) the
     *         predicate
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">estimateSelectivity</span><span class="token punctuation">(</span><span class="token keyword">int</span> field<span class="token punctuation">,</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> op<span class="token punctuation">,</span> <span class="token class-name">Field</span> constant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tupleDesc<span class="token punctuation">.</span><span class="token function">getFieldType</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token constant">INT_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> intHistogramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateSelectivity</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IntField</span><span class="token punctuation">)</span>constant<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> stringHistogramMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateSelectivity</span><span class="token punctuation">(</span>op<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">StringField</span><span class="token punctuation">)</span>constant<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * return the total number of tuples in this table
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">totalTuples</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">return</span> totalTuples<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br></div></div><p>读懂代码中的注释对写代码更有帮助</p> <h4 id="_2-2-4、-join-cardinality"><a href="#_2-2-4、-join-cardinality" class="header-anchor">#</a> 2.2.4、 Join Cardinality</h4> <p>Cardinality 是数据库和数据建模领域的一个重要的基础概念，数据库领域的 Cardinality 表示<strong>去重后唯一值（Unique Values）的数量</strong>，比如 Columns Cardinality 指列包含的不重复值的个数，数据建模中的 Cardinality 表示关系的类型。</p> <p>上面讨论的连接计划成本的计算方式为<code>joincost((t1 join t2) join t3)</code>，为了评估这个表达式，我们需要先估计t1 join t2的元组数ntups。这个连接基数估计问题比过滤器选择性估计问题更难。在本次实验，我们不需要为此做任何特别的事</p> <p>在实现简单的解决方案时，我们需要记住如下几点：</p> <ul><li>在这个版本的实验中，以下三段是不同的</li> <li>对于等值连接，当一个属性是主键时，连接操作产生的元组数量小于非主键属性的基数</li> <li>对于没有主键的等值连接，很难说清楚输出的元组数量–它可以是两个表的基数乘积的大小(如果两个表都有所有元组的值相同)–或者为0；可以构造一个简单的启发式(比如，两个表中较大的那个表的大小)</li> <li>对于范围扫描，说出准确的元组大小也很难；输出的元组大小应该与输入的元组大小成正比。可以假设距离扫描产生的叉乘是固定的一部分(例如30%)。通常，范围连接的代价应该大于两个大小相同的表的非主键等值连接的代价。</li></ul> <p><strong>练习3: Join Cost Estimation</strong></p> <p>JoinOptimizer.java类包含对连接排序和计算连接成本的所有方法，在这次练习中，你将会编写估计连接的可选择性和成本的方法：</p> <ul><li>实现estimateJoinCost(LogicalJoinNode j, int card1, int card2, double cost1, double cost2)：该方法估计连接j的成本，其中card1代表左侧输入的基数，card2代表右侧输入的基数(相当于元组数)，扫描左侧输入的成本为cost1，访问右侧输入的成本为cost2；我们可以使用上面提到的公式来估计连接操作的成本</li> <li>实现estimateJoinCardinality(LogicalJoinNode j, int card1, int card2, boolean t1pkey, boolean t2pkey)：该方法估计连接j输出的元组数；card1代表连接左侧输入元组的数量，card2代表连接右侧输入元组的数量，t1pkey和t2pkey代表左侧和右侧的列是否唯一(主键)</li></ul> <p>通过JoinOptimizerTest.java中的estimateJoinCostTest和estimateJoinCardinality测试代表通过本练习.</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">simpledb<span class="token punctuation">.</span>optimizer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Database</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span></span><span class="token class-name">ParsingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>execution<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">simpledb<span class="token punctuation">.</span>storage<span class="token punctuation">.</span></span><span class="token class-name">TupleDesc</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>rmi<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>swing<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>swing<span class="token punctuation">.</span>tree<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * The JoinOptimizer class is responsible for ordering a series of joins
 * optimally, and for selecting the best instantiation of a join for a given
 * logical plan.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JoinOptimizer</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">LogicalPlan</span> p<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joins<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Constructor
     *
     * @param p
     *            the logical plan being optimized
     * @param joins
     *            the list of joins being performed
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">JoinOptimizer</span><span class="token punctuation">(</span><span class="token class-name">LogicalPlan</span> p<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>joins <span class="token operator">=</span> joins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return best iterator for computing a given logical join, given the
     * specified statistics, and the provided left and right subplans. Note that
     * there is insufficient information to determine which plan should be the
     * inner/outer here -- because OpIterator's don't provide any cardinality
     * estimates, and stats only has information about the base tables. For this
     * reason, the plan1
     *
     * @param lj
     *            The join being considered
     * @param plan1
     *            The left join node's child
     * @param plan2
     *            The right join node's child
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">OpIterator</span> <span class="token function">instantiateJoin</span><span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> lj<span class="token punctuation">,</span>
                                             <span class="token class-name">OpIterator</span> plan1<span class="token punctuation">,</span> <span class="token class-name">OpIterator</span> plan2<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParsingException</span> <span class="token punctuation">{</span>

        <span class="token keyword">int</span> t1id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> t2id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name">OpIterator</span> j<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            t1id <span class="token operator">=</span> plan1<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fieldNameToIndex</span><span class="token punctuation">(</span>lj<span class="token punctuation">.</span>f1QuantifiedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParsingException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown field &quot;</span> <span class="token operator">+</span> lj<span class="token punctuation">.</span>f1QuantifiedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lj <span class="token keyword">instanceof</span> <span class="token class-name">LogicalSubplanJoinNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t2id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                t2id <span class="token operator">=</span> plan2<span class="token punctuation">.</span><span class="token function">getTupleDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fieldNameToIndex</span><span class="token punctuation">(</span>
                        lj<span class="token punctuation">.</span>f2QuantifiedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchElementException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParsingException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown field &quot;</span>
                        <span class="token operator">+</span> lj<span class="token punctuation">.</span>f2QuantifiedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">JoinPredicate</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JoinPredicate</span><span class="token punctuation">(</span>t1id<span class="token punctuation">,</span> lj<span class="token punctuation">.</span>p<span class="token punctuation">,</span> t2id<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>lj<span class="token punctuation">.</span>p <span class="token operator">==</span> <span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span><span class="token punctuation">.</span><span class="token constant">EQUALS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// dynamically load HashEquiJoin -- if it doesn't exist, just</span>
                <span class="token comment">// fall back on regular join</span>
                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;simpledb.execution.HashEquiJoin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Constructor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ct <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                j <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">OpIterator</span><span class="token punctuation">)</span> ct
                        <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> p<span class="token punctuation">,</span> plan1<span class="token punctuation">,</span> plan2 <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                j <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Join</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> plan1<span class="token punctuation">,</span> plan2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            j <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Join</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> plan1<span class="token punctuation">,</span> plan2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> j<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Estimate the cost of a join.
     *
     * The cost of the join should be calculated based on the join algorithm (or
     * algorithms) that you implemented for Lab 2. It should be a function of
     * the amount of data that must be read over the course of the query, as
     * well as the number of CPU opertions performed by your join. Assume that
     * the cost of a single predicate application is roughly 1.
     *
     *
     * @param j
     *            A LogicalJoinNode representing the join operation being
     *            performed.
     * @param card1
     *            Estimated cardinality of the left-hand side of the query
     * @param card2
     *            Estimated cardinality of the right-hand side of the query
     * @param cost1
     *            Estimated cost of one full scan of the table on the left-hand
     *            side of the query
     * @param cost2
     *            Estimated cost of one full scan of the table on the right-hand
     *            side of the query
     * @return An estimate of the cost of this query, in terms of cost1 and
     *         cost2
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">estimateJoinCost</span><span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> card1<span class="token punctuation">,</span> <span class="token keyword">int</span> card2<span class="token punctuation">,</span>
            <span class="token keyword">double</span> cost1<span class="token punctuation">,</span> <span class="token keyword">double</span> cost2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token keyword">instanceof</span> <span class="token class-name">LogicalSubplanJoinNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// A LogicalSubplanJoinNode represents a subquery.</span>
            <span class="token comment">// You do not need to implement proper support for these for Lab 3.</span>
            <span class="token keyword">return</span> card1 <span class="token operator">+</span> cost1 <span class="token operator">+</span> cost2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// Insert your code here.</span>
            <span class="token comment">// HINT: You may need to use the variable &quot;j&quot; if you implemented</span>
            <span class="token comment">// a join algorithm that's more complicated than a basic</span>
            <span class="token comment">// nested-loops join.</span>
            <span class="token comment">/**
             * 其中card1代表左侧输入的基数，card2代表右侧输入的基数(相当于元组数)
             * 扫描左侧输入的成本为cost1，访问右侧输入的成本为cost2；
             * IO总数加CPU总数,card为CPU总数
             */</span>
            <span class="token keyword">return</span> cost1 <span class="token operator">+</span> card1 <span class="token operator">*</span> card2 <span class="token operator">+</span> card1 <span class="token operator">*</span> cost2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Estimate the cardinality of a join. The cardinality of a join is the
     * number of tuples produced by the join.
     *
     * @param j
     *            A LogicalJoinNode representing the join operation being
     *            performed.
     * @param card1
     *            Cardinality of the left-hand table in the join
     * @param card2
     *            Cardinality of the right-hand table in the join
     * @param t1pkey
     *            Is the left-hand table a primary-key table?
     * @param t2pkey
     *            Is the right-hand table a primary-key table?
     * @param stats
     *            The table stats, referenced by table names, not alias
     * @return The cardinality of the join
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">estimateJoinCardinality</span><span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> j<span class="token punctuation">,</span> <span class="token keyword">int</span> card1<span class="token punctuation">,</span> <span class="token keyword">int</span> card2<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> t1pkey<span class="token punctuation">,</span> <span class="token keyword">boolean</span> t2pkey<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token keyword">instanceof</span> <span class="token class-name">LogicalSubplanJoinNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// A LogicalSubplanJoinNode represents a subquery.</span>
            <span class="token comment">// You do not need to implement proper support for these for Lab 3.</span>
            <span class="token keyword">return</span> card1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">estimateTableJoinCardinality</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>p<span class="token punctuation">,</span> j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">,</span> j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">,</span>
                    j<span class="token punctuation">.</span>f1PureName<span class="token punctuation">,</span> j<span class="token punctuation">.</span>f2PureName<span class="token punctuation">,</span> card1<span class="token punctuation">,</span> card2<span class="token punctuation">,</span> t1pkey<span class="token punctuation">,</span> t2pkey<span class="token punctuation">,</span>
                    stats<span class="token punctuation">,</span> p<span class="token punctuation">.</span><span class="token function">getTableAliasToIdMapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Estimate the join cardinality of two tables.
     * */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">estimateTableJoinCardinality</span><span class="token punctuation">(</span><span class="token class-name">Predicate<span class="token punctuation">.</span>Op</span> joinOp<span class="token punctuation">,</span>
                                                   <span class="token class-name">String</span> table1Alias<span class="token punctuation">,</span> <span class="token class-name">String</span> table2Alias<span class="token punctuation">,</span> <span class="token class-name">String</span> field1PureName<span class="token punctuation">,</span>
                                                   <span class="token class-name">String</span> field2PureName<span class="token punctuation">,</span> <span class="token keyword">int</span> card1<span class="token punctuation">,</span> <span class="token keyword">int</span> card2<span class="token punctuation">,</span> <span class="token keyword">boolean</span> t1pkey<span class="token punctuation">,</span>
                                                   <span class="token keyword">boolean</span> t2pkey<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
                                                   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> tableAliasToId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> card <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// some code goes here</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>joinOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">EQUALS</span><span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t1pkey <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t1pkey <span class="token operator">&amp;&amp;</span> t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card1<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1pkey <span class="token operator">&amp;&amp;</span> t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>card1<span class="token punctuation">,</span> card2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>card1<span class="token punctuation">,</span> card2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">NOT_EQUALS</span><span class="token operator">:</span>
                <span class="token comment">//使用记录总数-等值记录数的方法去算</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t1pkey <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card1 <span class="token operator">*</span> card2 <span class="token operator">-</span> card2<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t1pkey <span class="token operator">&amp;&amp;</span> t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card1 <span class="token operator">*</span> card2 <span class="token operator">-</span> card1<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t1pkey <span class="token operator">&amp;&amp;</span> t2pkey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card1 <span class="token operator">*</span> card2 <span class="token operator">-</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>card1<span class="token punctuation">,</span> card2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    card <span class="token operator">=</span> card1 <span class="token operator">*</span> card2 <span class="token operator">-</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>card1<span class="token punctuation">,</span> card2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment">//其它记录按范围查询来算</span>
                card <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">0.3</span> <span class="token operator">*</span> card1 <span class="token operator">*</span> card2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> card <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> card<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Helper method to enumerate all of the subsets of a given size of a
     * specified vector.
     *
     * @param v
     *            The vector whose subsets are desired
     * @param size
     *            The size of the subsets of interest
     * @return a set of all subsets of the specified size
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">enumerateSubsets</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> v<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> els <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        els.add(new HashSet&lt;&gt;());</span>
        <span class="token comment">// Iterator&lt;Set&gt; it;</span>
        <span class="token comment">// long start = System.currentTimeMillis();</span>
        <span class="token function">dfs</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> els<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> els<span class="token punctuation">;</span>
<span class="token comment">//        for (int i = 0; i &lt; size; i++) {</span>
<span class="token comment">//            Set&lt;Set&lt;T&gt;&gt; newels = new HashSet&lt;&gt;();</span>
<span class="token comment">//            for (Set&lt;T&gt; s : els) {</span>
<span class="token comment">//                for (T t : v) {</span>
<span class="token comment">//                    Set&lt;T&gt; news = new HashSet&lt;&gt;(s);</span>
<span class="token comment">//                    if (news.add(t))</span>
<span class="token comment">//                        newels.add(news);</span>
<span class="token comment">//                }</span>
<span class="token comment">//            }</span>
<span class="token comment">//            els = newels;</span>
<span class="token comment">//        }</span>
<span class="token comment">//</span>
<span class="token comment">//        return els;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> begin<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> res<span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> path<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> size<span class="token punctuation">)</span><span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> begin<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            path<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">dfs</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> size<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>res<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            path<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Compute a logical, reasonably efficient join on the specified tables. See
     * PS4 for hints on how this should be implemented.
     *
     * @param stats
     *            Statistics for each table involved in the join, referenced by
     *            base table names, not alias
     * @param filterSelectivities
     *            Selectivities of the filter predicates on each table in the
     *            join, referenced by table alias (if no alias, the base table
     *            name)
     * @param explain
     *            Indicates whether your code should explain its query plan or
     *            simply execute it
     * @return A List&lt;LogicalJoinNode&gt; that stores joins in the left-deep
     *         order in which they should be executed.
     * @throws ParsingException
     *             when stats or filter selectivities is missing a table in the
     *             join, or or when another internal error occurs
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">orderJoins</span><span class="token punctuation">(</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> filterSelectivities<span class="token punctuation">,</span> <span class="token keyword">boolean</span> explain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ParsingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// some code goes here</span>
        <span class="token comment">//Replace the following</span>
        <span class="token class-name">PlanCache</span> planCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlanCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CostCard</span> bestCostCard <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CostCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> joins<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//找出size的所有子集</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> subsets <span class="token operator">=</span> <span class="token function">enumerateSubsets</span><span class="token punctuation">(</span>joins<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> subset<span class="token operator">:</span> subsets<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">double</span> bestCost <span class="token operator">=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> joinNode <span class="token operator">:</span> subset<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token comment">//找出最优的方案：依据planCache和计算subset - joinNode的最优值,动态规划类似的做法</span>
                    <span class="token class-name">CostCard</span> costCard <span class="token operator">=</span> <span class="token function">computeCostAndCardOfSubplan</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> filterSelectivities<span class="token punctuation">,</span>
                            joinNode<span class="token punctuation">,</span> subset<span class="token punctuation">,</span> bestCost<span class="token punctuation">,</span> planCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>costCard <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    bestCost <span class="token operator">=</span> costCard<span class="token punctuation">.</span>cost<span class="token punctuation">;</span>
                    bestCostCard <span class="token operator">=</span> costCard<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>bestCost <span class="token operator">!=</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    planCache<span class="token punctuation">.</span><span class="token function">addPlan</span><span class="token punctuation">(</span>subset<span class="token punctuation">,</span> bestCostCard<span class="token punctuation">.</span>cost<span class="token punctuation">,</span> bestCostCard<span class="token punctuation">.</span>card<span class="token punctuation">,</span> bestCostCard<span class="token punctuation">.</span>plan<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>explain<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">printJoins</span><span class="token punctuation">(</span>bestCostCard<span class="token punctuation">.</span>plan<span class="token punctuation">,</span> planCache<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> filterSelectivities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bestCostCard<span class="token punctuation">.</span>plan<span class="token punctuation">;</span>
        <span class="token comment">//7s到5s</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ===================== Private Methods =================================</span>

    <span class="token comment">/**
     * This is a helper method that computes the cost and cardinality of joining
     * joinToRemove to joinSet (joinSet should contain joinToRemove), given that
     * all of the subsets of size joinSet.size() - 1 have already been computed
     * and stored in PlanCache pc.
     *
     * @param stats
     *            table stats for all of the tables, referenced by table names
     *            rather than alias (see {@link #orderJoins})
     * @param filterSelectivities
     *            the selectivities of the filters over each of the tables
     *            (where tables are indentified by their alias or name if no
     *            alias is given)
     * @param joinToRemove
     *            the join to remove from joinSet
     * @param joinSet
     *            the set of joins being considered
     * @param bestCostSoFar
     *            the best way to join joinSet so far (minimum of previous
     *            invocations of computeCostAndCardOfSubplan for this joinSet,
     *            from returned CostCard)
     * @param pc
     *            the PlanCache for this join; should have subplans for all
     *            plans of size joinSet.size()-1
     * @return A {@link CostCard} objects desribing the cost, cardinality,
     *         optimal subplan
     * @throws ParsingException
     *             when stats, filterSelectivities, or pc object is missing
     *             tables involved in join
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">CostCard</span> <span class="token function">computeCostAndCardOfSubplan</span><span class="token punctuation">(</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> filterSelectivities<span class="token punctuation">,</span>
            <span class="token class-name">LogicalJoinNode</span> joinToRemove<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joinSet<span class="token punctuation">,</span>
            <span class="token keyword">double</span> bestCostSoFar<span class="token punctuation">,</span> <span class="token class-name">PlanCache</span> pc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParsingException</span> <span class="token punctuation">{</span>

        <span class="token class-name">LogicalJoinNode</span> j <span class="token operator">=</span> joinToRemove<span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> prevBest<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParsingException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown table &quot;</span> <span class="token operator">+</span> j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ParsingException</span><span class="token punctuation">(</span><span class="token string">&quot;Unknown table &quot;</span> <span class="token operator">+</span> j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> table1Name <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> table2Name <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> table1Alias <span class="token operator">=</span> j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">;</span>
        <span class="token class-name">String</span> table2Alias <span class="token operator">=</span> j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">;</span>

        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> news <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>joinSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        news<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">double</span> t1cost<span class="token punctuation">,</span> t2cost<span class="token punctuation">;</span>
        <span class="token keyword">int</span> t1card<span class="token punctuation">,</span> t2card<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> leftPkey<span class="token punctuation">,</span> rightPkey<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>news<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// base case -- both are base relations</span>
            prevBest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1cost <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1card <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                    filterSelectivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            leftPkey <span class="token operator">=</span> <span class="token function">isPkey</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">,</span> j<span class="token punctuation">.</span>f1PureName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            t2cost <span class="token operator">=</span> table2Alias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t2card <span class="token operator">=</span> table2Alias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                            filterSelectivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rightPkey <span class="token operator">=</span> table2Alias <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPkey</span><span class="token punctuation">(</span>table2Alias<span class="token punctuation">,</span>
                    j<span class="token punctuation">.</span>f2PureName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// news is not empty -- figure best way to join j to news</span>
            prevBest <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getOrder</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// possible that we have not cached an answer, if subset</span>
            <span class="token comment">// includes a cross product</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prevBest <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">double</span> prevBestCost <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getCost</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bestCard <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getCard</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// estimate cost of right subtree</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doesJoin</span><span class="token punctuation">(</span>prevBest<span class="token punctuation">,</span> table1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// j.t1 is in prevBest</span>
                t1cost <span class="token operator">=</span> prevBestCost<span class="token punctuation">;</span> <span class="token comment">// left side just has cost of whatever</span>
                                       <span class="token comment">// left</span>
                <span class="token comment">// subtree is</span>
                t1card <span class="token operator">=</span> bestCard<span class="token punctuation">;</span>
                leftPkey <span class="token operator">=</span> <span class="token function">hasPkey</span><span class="token punctuation">(</span>prevBest<span class="token punctuation">)</span><span class="token punctuation">;</span>

                t2cost <span class="token operator">=</span> j<span class="token punctuation">.</span>t2Alias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                t2card <span class="token operator">=</span> j<span class="token punctuation">.</span>t2Alias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                                filterSelectivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rightPkey <span class="token operator">=</span> j<span class="token punctuation">.</span>t2Alias <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPkey</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">,</span>
                        j<span class="token punctuation">.</span>f2PureName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doesJoin</span><span class="token punctuation">(</span>prevBest<span class="token punctuation">,</span> j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// j.t2 is in prevbest</span>
                                                        <span class="token comment">// (both</span>
                <span class="token comment">// shouldn't be)</span>
                t2cost <span class="token operator">=</span> prevBestCost<span class="token punctuation">;</span> <span class="token comment">// left side just has cost of whatever</span>
                                       <span class="token comment">// left</span>
                <span class="token comment">// subtree is</span>
                t2card <span class="token operator">=</span> bestCard<span class="token punctuation">;</span>
                rightPkey <span class="token operator">=</span> <span class="token function">hasPkey</span><span class="token punctuation">(</span>prevBest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t1cost <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                t1card <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                        filterSelectivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                leftPkey <span class="token operator">=</span> <span class="token function">isPkey</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">,</span> j<span class="token punctuation">.</span>f1PureName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// don't consider this plan if one of j.t1 or j.t2</span>
                <span class="token comment">// isn't a table joined in prevBest (cross product)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// case where prevbest is left</span>
        <span class="token keyword">double</span> cost1 <span class="token operator">=</span> <span class="token function">estimateJoinCost</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> t1card<span class="token punctuation">,</span> t2card<span class="token punctuation">,</span> t1cost<span class="token punctuation">,</span> t2cost<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LogicalJoinNode</span> j2 <span class="token operator">=</span> j<span class="token punctuation">.</span><span class="token function">swapInnerOuter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> cost2 <span class="token operator">=</span> <span class="token function">estimateJoinCost</span><span class="token punctuation">(</span>j2<span class="token punctuation">,</span> t2card<span class="token punctuation">,</span> t1card<span class="token punctuation">,</span> t2cost<span class="token punctuation">,</span> t1cost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cost2 <span class="token operator">&lt;</span> cost1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> tmp<span class="token punctuation">;</span>
            j <span class="token operator">=</span> j2<span class="token punctuation">;</span>
            cost1 <span class="token operator">=</span> cost2<span class="token punctuation">;</span>
            tmp <span class="token operator">=</span> rightPkey<span class="token punctuation">;</span>
            rightPkey <span class="token operator">=</span> leftPkey<span class="token punctuation">;</span>
            leftPkey <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cost1 <span class="token operator">&gt;=</span> bestCostSoFar<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">CostCard</span> cc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CostCard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cc<span class="token punctuation">.</span>card <span class="token operator">=</span> <span class="token function">estimateJoinCardinality</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> t1card<span class="token punctuation">,</span> t2card<span class="token punctuation">,</span> leftPkey<span class="token punctuation">,</span>
                rightPkey<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>cost <span class="token operator">=</span> cost1<span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>plan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>prevBest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cc<span class="token punctuation">.</span>plan<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// prevbest is left -- add new join to end</span>
        <span class="token keyword">return</span> cc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return true if the specified table is in the list of joins, false
     * otherwise
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">doesJoin</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joinlist<span class="token punctuation">,</span> <span class="token class-name">String</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> j <span class="token operator">:</span> joinlist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return true if field is a primary key of the specified table, false
     * otherwise
     *
     * @param tableAlias
     *            The alias of the table in the query
     * @param field
     *            The pure name of the field
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isPkey</span><span class="token punctuation">(</span><span class="token class-name">String</span> tableAlias<span class="token punctuation">,</span> <span class="token class-name">String</span> field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> tid1 <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>tableAlias<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> pkey1 <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrimaryKey</span><span class="token punctuation">(</span>tid1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> pkey1<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Return true if a primary key field is joined by one of the joins in
     * joinlist
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasPkey</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joinlist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> j <span class="token operator">:</span> joinlist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPkey</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">,</span> j<span class="token punctuation">.</span>f1PureName<span class="token punctuation">)</span>
                    <span class="token operator">||</span> <span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPkey</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">,</span> j<span class="token punctuation">.</span>f2PureName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Helper function to display a Swing window with a tree representation of
     * the specified list of joins. See {@link #orderJoins}, which may want to
     * call this when the analyze flag is true.
     *
     * @param js
     *            the join plan to visualize
     * @param pc
     *            the PlanCache accumulated whild building the optimal plan
     * @param stats
     *            table statistics for base tables
     * @param selectivities
     *            the selectivities of the filters over each of the tables
     *            (where tables are indentified by their alias or name if no
     *            alias is given)
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printJoins</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> js<span class="token punctuation">,</span> <span class="token class-name">PlanCache</span> pc<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> selectivities<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">JFrame</span> f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JFrame</span><span class="token punctuation">(</span><span class="token string">&quot;Join Plan for &quot;</span> <span class="token operator">+</span> p<span class="token punctuation">.</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the default close operation for the window,</span>
        <span class="token comment">// or else the program won't exit when clicking close button</span>
        f<span class="token punctuation">.</span><span class="token function">setDefaultCloseOperation</span><span class="token punctuation">(</span><span class="token class-name">WindowConstants</span><span class="token punctuation">.</span><span class="token constant">DISPOSE_ON_CLOSE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        f<span class="token punctuation">.</span><span class="token function">setVisible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        f<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultMutableTreeNode</span><span class="token punctuation">&gt;</span></span> m <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// int numTabs = 0;</span>

        <span class="token comment">// int k;</span>
        <span class="token class-name">DefaultMutableTreeNode</span> root <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> treetop <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> pathSoFar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> neither<span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>js<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LogicalJoinNode</span> j <span class="token operator">:</span> js<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pathSoFar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;PATH SO FAR = &quot;</span> <span class="token operator">+</span> pathSoFar<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">String</span> table1Name <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> table2Name <span class="token operator">=</span> <span class="token class-name">Database</span><span class="token punctuation">.</span><span class="token function">getCatalog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTableName</span><span class="token punctuation">(</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">getTableId</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Double c = pc.getCost(pathSoFar);</span>
            neither <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMutableTreeNode</span><span class="token punctuation">(</span><span class="token string">&quot;Join &quot;</span> <span class="token operator">+</span> j <span class="token operator">+</span> <span class="token string">&quot; (Cost =&quot;</span>
                    <span class="token operator">+</span> pc<span class="token punctuation">.</span><span class="token function">getCost</span><span class="token punctuation">(</span>pathSoFar<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, card = &quot;</span>
                    <span class="token operator">+</span> pc<span class="token punctuation">.</span><span class="token function">getCard</span><span class="token punctuation">(</span>pathSoFar<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DefaultMutableTreeNode</span> n <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// never seen this table before</span>
                n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMutableTreeNode</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias
                        <span class="token operator">+</span> <span class="token string">&quot; (Cost = &quot;</span>
                        <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token operator">+</span> <span class="token string">&quot;, card = &quot;</span>
                        <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table1Name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                                selectivities<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                root<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// make left child root n</span>
                root<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                neither <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t1Alias<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            n <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// never seen this table before</span>

                n <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMutableTreeNode</span><span class="token punctuation">(</span>
                        j<span class="token punctuation">.</span>t2Alias <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;Subplan&quot;</span>
                                <span class="token operator">:</span> <span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias
                                        <span class="token operator">+</span> <span class="token string">&quot; (Cost = &quot;</span>
                                        <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">estimateScanCost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token operator">+</span> <span class="token string">&quot;, card = &quot;</span>
                                        <span class="token operator">+</span> stats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>table2Name<span class="token punctuation">)</span>
                                                <span class="token punctuation">.</span><span class="token function">estimateTableCardinality</span><span class="token punctuation">(</span>
                                                        selectivities
                                                                <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                root<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// make right child root n</span>
                root<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                neither <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            m<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>j<span class="token punctuation">.</span>t2Alias<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// unless this table doesn't join with other tables,</span>
            <span class="token comment">// all tables are accessed from root</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>neither<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> m<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    m<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            treetop <span class="token operator">=</span> root<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">JTree</span> tree <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JTree</span><span class="token punctuation">(</span>treetop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JScrollPane</span> treeView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JScrollPane</span><span class="token punctuation">(</span>tree<span class="token punctuation">)</span><span class="token punctuation">;</span>

        tree<span class="token punctuation">.</span><span class="token function">setShowsRootHandles</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Set the icon for leaf nodes.</span>
        <span class="token class-name">ImageIcon</span> leafIcon <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImageIcon</span><span class="token punctuation">(</span><span class="token string">&quot;join.jpg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DefaultTreeCellRenderer</span> renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultTreeCellRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderer<span class="token punctuation">.</span><span class="token function">setOpenIcon</span><span class="token punctuation">(</span>leafIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>
        renderer<span class="token punctuation">.</span><span class="token function">setClosedIcon</span><span class="token punctuation">(</span>leafIcon<span class="token punctuation">)</span><span class="token punctuation">;</span>

        tree<span class="token punctuation">.</span><span class="token function">setCellRenderer</span><span class="token punctuation">(</span>renderer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        f<span class="token punctuation">.</span><span class="token function">setSize</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        f<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>treeView<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tree<span class="token punctuation">.</span><span class="token function">getRowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tree<span class="token punctuation">.</span><span class="token function">expandRow</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>js<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            f<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JLabel</span><span class="token punctuation">(</span><span class="token string">&quot;No joins in plan.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        f<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br><span class="line-number">227</span><br><span class="line-number">228</span><br><span class="line-number">229</span><br><span class="line-number">230</span><br><span class="line-number">231</span><br><span class="line-number">232</span><br><span class="line-number">233</span><br><span class="line-number">234</span><br><span class="line-number">235</span><br><span class="line-number">236</span><br><span class="line-number">237</span><br><span class="line-number">238</span><br><span class="line-number">239</span><br><span class="line-number">240</span><br><span class="line-number">241</span><br><span class="line-number">242</span><br><span class="line-number">243</span><br><span class="line-number">244</span><br><span class="line-number">245</span><br><span class="line-number">246</span><br><span class="line-number">247</span><br><span class="line-number">248</span><br><span class="line-number">249</span><br><span class="line-number">250</span><br><span class="line-number">251</span><br><span class="line-number">252</span><br><span class="line-number">253</span><br><span class="line-number">254</span><br><span class="line-number">255</span><br><span class="line-number">256</span><br><span class="line-number">257</span><br><span class="line-number">258</span><br><span class="line-number">259</span><br><span class="line-number">260</span><br><span class="line-number">261</span><br><span class="line-number">262</span><br><span class="line-number">263</span><br><span class="line-number">264</span><br><span class="line-number">265</span><br><span class="line-number">266</span><br><span class="line-number">267</span><br><span class="line-number">268</span><br><span class="line-number">269</span><br><span class="line-number">270</span><br><span class="line-number">271</span><br><span class="line-number">272</span><br><span class="line-number">273</span><br><span class="line-number">274</span><br><span class="line-number">275</span><br><span class="line-number">276</span><br><span class="line-number">277</span><br><span class="line-number">278</span><br><span class="line-number">279</span><br><span class="line-number">280</span><br><span class="line-number">281</span><br><span class="line-number">282</span><br><span class="line-number">283</span><br><span class="line-number">284</span><br><span class="line-number">285</span><br><span class="line-number">286</span><br><span class="line-number">287</span><br><span class="line-number">288</span><br><span class="line-number">289</span><br><span class="line-number">290</span><br><span class="line-number">291</span><br><span class="line-number">292</span><br><span class="line-number">293</span><br><span class="line-number">294</span><br><span class="line-number">295</span><br><span class="line-number">296</span><br><span class="line-number">297</span><br><span class="line-number">298</span><br><span class="line-number">299</span><br><span class="line-number">300</span><br><span class="line-number">301</span><br><span class="line-number">302</span><br><span class="line-number">303</span><br><span class="line-number">304</span><br><span class="line-number">305</span><br><span class="line-number">306</span><br><span class="line-number">307</span><br><span class="line-number">308</span><br><span class="line-number">309</span><br><span class="line-number">310</span><br><span class="line-number">311</span><br><span class="line-number">312</span><br><span class="line-number">313</span><br><span class="line-number">314</span><br><span class="line-number">315</span><br><span class="line-number">316</span><br><span class="line-number">317</span><br><span class="line-number">318</span><br><span class="line-number">319</span><br><span class="line-number">320</span><br><span class="line-number">321</span><br><span class="line-number">322</span><br><span class="line-number">323</span><br><span class="line-number">324</span><br><span class="line-number">325</span><br><span class="line-number">326</span><br><span class="line-number">327</span><br><span class="line-number">328</span><br><span class="line-number">329</span><br><span class="line-number">330</span><br><span class="line-number">331</span><br><span class="line-number">332</span><br><span class="line-number">333</span><br><span class="line-number">334</span><br><span class="line-number">335</span><br><span class="line-number">336</span><br><span class="line-number">337</span><br><span class="line-number">338</span><br><span class="line-number">339</span><br><span class="line-number">340</span><br><span class="line-number">341</span><br><span class="line-number">342</span><br><span class="line-number">343</span><br><span class="line-number">344</span><br><span class="line-number">345</span><br><span class="line-number">346</span><br><span class="line-number">347</span><br><span class="line-number">348</span><br><span class="line-number">349</span><br><span class="line-number">350</span><br><span class="line-number">351</span><br><span class="line-number">352</span><br><span class="line-number">353</span><br><span class="line-number">354</span><br><span class="line-number">355</span><br><span class="line-number">356</span><br><span class="line-number">357</span><br><span class="line-number">358</span><br><span class="line-number">359</span><br><span class="line-number">360</span><br><span class="line-number">361</span><br><span class="line-number">362</span><br><span class="line-number">363</span><br><span class="line-number">364</span><br><span class="line-number">365</span><br><span class="line-number">366</span><br><span class="line-number">367</span><br><span class="line-number">368</span><br><span class="line-number">369</span><br><span class="line-number">370</span><br><span class="line-number">371</span><br><span class="line-number">372</span><br><span class="line-number">373</span><br><span class="line-number">374</span><br><span class="line-number">375</span><br><span class="line-number">376</span><br><span class="line-number">377</span><br><span class="line-number">378</span><br><span class="line-number">379</span><br><span class="line-number">380</span><br><span class="line-number">381</span><br><span class="line-number">382</span><br><span class="line-number">383</span><br><span class="line-number">384</span><br><span class="line-number">385</span><br><span class="line-number">386</span><br><span class="line-number">387</span><br><span class="line-number">388</span><br><span class="line-number">389</span><br><span class="line-number">390</span><br><span class="line-number">391</span><br><span class="line-number">392</span><br><span class="line-number">393</span><br><span class="line-number">394</span><br><span class="line-number">395</span><br><span class="line-number">396</span><br><span class="line-number">397</span><br><span class="line-number">398</span><br><span class="line-number">399</span><br><span class="line-number">400</span><br><span class="line-number">401</span><br><span class="line-number">402</span><br><span class="line-number">403</span><br><span class="line-number">404</span><br><span class="line-number">405</span><br><span class="line-number">406</span><br><span class="line-number">407</span><br><span class="line-number">408</span><br><span class="line-number">409</span><br><span class="line-number">410</span><br><span class="line-number">411</span><br><span class="line-number">412</span><br><span class="line-number">413</span><br><span class="line-number">414</span><br><span class="line-number">415</span><br><span class="line-number">416</span><br><span class="line-number">417</span><br><span class="line-number">418</span><br><span class="line-number">419</span><br><span class="line-number">420</span><br><span class="line-number">421</span><br><span class="line-number">422</span><br><span class="line-number">423</span><br><span class="line-number">424</span><br><span class="line-number">425</span><br><span class="line-number">426</span><br><span class="line-number">427</span><br><span class="line-number">428</span><br><span class="line-number">429</span><br><span class="line-number">430</span><br><span class="line-number">431</span><br><span class="line-number">432</span><br><span class="line-number">433</span><br><span class="line-number">434</span><br><span class="line-number">435</span><br><span class="line-number">436</span><br><span class="line-number">437</span><br><span class="line-number">438</span><br><span class="line-number">439</span><br><span class="line-number">440</span><br><span class="line-number">441</span><br><span class="line-number">442</span><br><span class="line-number">443</span><br><span class="line-number">444</span><br><span class="line-number">445</span><br><span class="line-number">446</span><br><span class="line-number">447</span><br><span class="line-number">448</span><br><span class="line-number">449</span><br><span class="line-number">450</span><br><span class="line-number">451</span><br><span class="line-number">452</span><br><span class="line-number">453</span><br><span class="line-number">454</span><br><span class="line-number">455</span><br><span class="line-number">456</span><br><span class="line-number">457</span><br><span class="line-number">458</span><br><span class="line-number">459</span><br><span class="line-number">460</span><br><span class="line-number">461</span><br><span class="line-number">462</span><br><span class="line-number">463</span><br><span class="line-number">464</span><br><span class="line-number">465</span><br><span class="line-number">466</span><br><span class="line-number">467</span><br><span class="line-number">468</span><br><span class="line-number">469</span><br><span class="line-number">470</span><br><span class="line-number">471</span><br><span class="line-number">472</span><br><span class="line-number">473</span><br><span class="line-number">474</span><br><span class="line-number">475</span><br><span class="line-number">476</span><br><span class="line-number">477</span><br><span class="line-number">478</span><br><span class="line-number">479</span><br><span class="line-number">480</span><br><span class="line-number">481</span><br><span class="line-number">482</span><br><span class="line-number">483</span><br><span class="line-number">484</span><br><span class="line-number">485</span><br><span class="line-number">486</span><br><span class="line-number">487</span><br><span class="line-number">488</span><br><span class="line-number">489</span><br><span class="line-number">490</span><br><span class="line-number">491</span><br><span class="line-number">492</span><br><span class="line-number">493</span><br><span class="line-number">494</span><br><span class="line-number">495</span><br><span class="line-number">496</span><br><span class="line-number">497</span><br><span class="line-number">498</span><br><span class="line-number">499</span><br><span class="line-number">500</span><br><span class="line-number">501</span><br><span class="line-number">502</span><br><span class="line-number">503</span><br><span class="line-number">504</span><br><span class="line-number">505</span><br><span class="line-number">506</span><br><span class="line-number">507</span><br><span class="line-number">508</span><br><span class="line-number">509</span><br><span class="line-number">510</span><br><span class="line-number">511</span><br><span class="line-number">512</span><br><span class="line-number">513</span><br><span class="line-number">514</span><br><span class="line-number">515</span><br><span class="line-number">516</span><br><span class="line-number">517</span><br><span class="line-number">518</span><br><span class="line-number">519</span><br><span class="line-number">520</span><br><span class="line-number">521</span><br><span class="line-number">522</span><br><span class="line-number">523</span><br><span class="line-number">524</span><br><span class="line-number">525</span><br><span class="line-number">526</span><br><span class="line-number">527</span><br><span class="line-number">528</span><br><span class="line-number">529</span><br><span class="line-number">530</span><br><span class="line-number">531</span><br><span class="line-number">532</span><br><span class="line-number">533</span><br><span class="line-number">534</span><br><span class="line-number">535</span><br><span class="line-number">536</span><br><span class="line-number">537</span><br><span class="line-number">538</span><br><span class="line-number">539</span><br><span class="line-number">540</span><br><span class="line-number">541</span><br><span class="line-number">542</span><br><span class="line-number">543</span><br><span class="line-number">544</span><br><span class="line-number">545</span><br><span class="line-number">546</span><br><span class="line-number">547</span><br><span class="line-number">548</span><br><span class="line-number">549</span><br><span class="line-number">550</span><br><span class="line-number">551</span><br><span class="line-number">552</span><br><span class="line-number">553</span><br><span class="line-number">554</span><br><span class="line-number">555</span><br><span class="line-number">556</span><br><span class="line-number">557</span><br><span class="line-number">558</span><br><span class="line-number">559</span><br><span class="line-number">560</span><br><span class="line-number">561</span><br><span class="line-number">562</span><br><span class="line-number">563</span><br><span class="line-number">564</span><br><span class="line-number">565</span><br><span class="line-number">566</span><br><span class="line-number">567</span><br><span class="line-number">568</span><br><span class="line-number">569</span><br><span class="line-number">570</span><br><span class="line-number">571</span><br><span class="line-number">572</span><br><span class="line-number">573</span><br><span class="line-number">574</span><br><span class="line-number">575</span><br><span class="line-number">576</span><br><span class="line-number">577</span><br><span class="line-number">578</span><br><span class="line-number">579</span><br><span class="line-number">580</span><br><span class="line-number">581</span><br><span class="line-number">582</span><br><span class="line-number">583</span><br><span class="line-number">584</span><br><span class="line-number">585</span><br><span class="line-number">586</span><br><span class="line-number">587</span><br><span class="line-number">588</span><br><span class="line-number">589</span><br><span class="line-number">590</span><br><span class="line-number">591</span><br><span class="line-number">592</span><br><span class="line-number">593</span><br><span class="line-number">594</span><br><span class="line-number">595</span><br><span class="line-number">596</span><br><span class="line-number">597</span><br><span class="line-number">598</span><br><span class="line-number">599</span><br><span class="line-number">600</span><br><span class="line-number">601</span><br><span class="line-number">602</span><br><span class="line-number">603</span><br><span class="line-number">604</span><br><span class="line-number">605</span><br><span class="line-number">606</span><br><span class="line-number">607</span><br><span class="line-number">608</span><br><span class="line-number">609</span><br><span class="line-number">610</span><br><span class="line-number">611</span><br><span class="line-number">612</span><br><span class="line-number">613</span><br><span class="line-number">614</span><br><span class="line-number">615</span><br><span class="line-number">616</span><br><span class="line-number">617</span><br><span class="line-number">618</span><br><span class="line-number">619</span><br><span class="line-number">620</span><br><span class="line-number">621</span><br><span class="line-number">622</span><br><span class="line-number">623</span><br><span class="line-number">624</span><br><span class="line-number">625</span><br><span class="line-number">626</span><br><span class="line-number">627</span><br><span class="line-number">628</span><br><span class="line-number">629</span><br><span class="line-number">630</span><br><span class="line-number">631</span><br><span class="line-number">632</span><br><span class="line-number">633</span><br><span class="line-number">634</span><br><span class="line-number">635</span><br><span class="line-number">636</span><br><span class="line-number">637</span><br><span class="line-number">638</span><br><span class="line-number">639</span><br><span class="line-number">640</span><br><span class="line-number">641</span><br></div></div><p>如果读懂了本节列举的三点注意事项，就能实现estimateTableJoinCardinality方法 .</p> <h3 id="_2-3、连接排序"><a href="#_2-3、连接排序" class="header-anchor">#</a> 2.3、连接排序</h3> <p>目前我们已经实现了成本估计的方法，接下来将要多查询计划进行优化。对于这些方法，连接表现为连接节点的列表，而不是类中描述的连接关系的列表</p> <p>将课件中的算法翻译成伪代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token number">1.</span> j <span class="token operator">=</span> set of join nodes
<span class="token number">2.</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>i in <span class="token number">1.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>|j<span class="token operator">|</span><span class="token punctuation">)</span><span class="token operator">:</span>
<span class="token number">3.</span>     <span class="token keyword">for</span> s in <span class="token punctuation">{</span>all length i subsets of j<span class="token punctuation">}</span>
<span class="token number">4.</span>       bestPlan <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token number">5.</span>       <span class="token keyword">for</span> s' in <span class="token punctuation">{</span>all length d<span class="token operator">-</span><span class="token number">1</span> subsets of s<span class="token punctuation">}</span>
<span class="token number">6.</span>            subplan <span class="token operator">=</span> <span class="token function">optjoin</span><span class="token punctuation">(</span>s'<span class="token punctuation">)</span>
<span class="token number">7.</span>            plan <span class="token operator">=</span> best way <span class="token keyword">to</span> <span class="token namespace">join</span> <span class="token punctuation">(</span>s<span class="token operator">-</span>s'<span class="token punctuation">)</span> <span class="token keyword">to</span> <span class="token namespace">subplan</span>
<span class="token number">8.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cost</span><span class="token punctuation">(</span>plan<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">cost</span><span class="token punctuation">(</span>bestPlan<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">9.</span>               bestPlan <span class="token operator">=</span> plan
<span class="token number">10.</span>      <span class="token function">optjoin</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">=</span> bestPlan
<span class="token number">11.</span> <span class="token keyword">return</span> <span class="token function">optjoin</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>源码中已经提供了一些类和方法来帮助我们实现上述算法</p> <p>首先，JoinOptimizer.java中方法：enumeraterSubsets(List v, int size)为我们返回列表v的大小为size的子集。但是该方法的效率较低，不适用于大型集合，我们可以修改为更加便捷的方式，例如使用递归+回溯的方式求子集，具体可以参考leetcode</p> <p>其次，源码中还提供了如下方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">CostCard</span> <span class="token function">computeCostAndCardOfSubplan</span><span class="token punctuation">(</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> filterSelectivities<span class="token punctuation">,</span>
            <span class="token class-name">LogicalJoinNode</span> joinToRemove<span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> joinSet<span class="token punctuation">,</span>
            <span class="token keyword">double</span> bestCostSoFar<span class="token punctuation">,</span> <span class="token class-name">PlanCache</span> pc<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ParsingException</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>给出连接的子集<code>joinSet</code>，以及需要从集合中移除的连接<code>joinToRemove</code>，该方法计算将<code>joinToRemove</code>加入到<code>joinSet-{joinToRemove}</code>的最佳排序方式。它返回CostCard对象，该对象包含成本、基数和最佳的连接顺序(以列表形式返回)。</p> <p>如果无法找到最优的计划(例如，没有最左连接是可能的）,<code>computeCostAndCardOfSubplan</code>方法可能返回null，或者所有计划的成本均大于<code>bestCostSoFar</code>参数。该方法通过参数planCache(先前以排序连接的缓存)来快速查找将将<code>joinToRemove</code>加入到<code>joinSet-{joinToRemove}</code>的最快方法。其他参数(stats &amp; filterSelectivities)是我们在练习4中实现的orderJoins方法传递过来的.</p> <p>此外，源码中还提供printJoins方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">printJoins</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> js<span class="token punctuation">,</span> <span class="token class-name">PlanCache</span> pc<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> selectivities<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该方法主要用于以图的形式展示连接计划</p> <p>最后，源码中还提供了PlanCache类，该类能缓存连接子集的最佳排序方式(它的实例被用于方法：computeCostAndCardOfSubplan).</p> <p><strong>练习4: Join Ordering</strong></p> <p>在JoinOptimizer.java中，实现下述方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LogicalJoinNode</span><span class="token punctuation">&gt;</span></span> <span class="token function">orderJoins</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TableStats</span><span class="token punctuation">&gt;</span></span> stats<span class="token punctuation">,</span> 
                   <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">&gt;</span></span> filterSelectivities<span class="token punctuation">,</span>  
                   <span class="token keyword">boolean</span> explain<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>该方法应该对连接类成员进行操作，并且返回指定连接执行顺序的新列表。列表中的第一号元素代表执行计划的最左侧、最底层的操作。返回列表中的相邻连接应该至少共享一个字段，以确保计划是左深的。<code>stats</code>对象帮助我们找到查询计划中出现的表的<code>TableStats</code>，<code>filterSelectivities</code>允许我们找到表上任何谓词的可选择性；它保证<code>From</code>列表中的每张表都有一个条目。最后，explain参数表示我们是否应该输出连接顺序(也就是是否调用printJoins方法)</p> <p>我们实现该方法时需要使用上面提到的协助我们实现的方法。粗略地讲，我们的实现应该遵循上面的伪代码，遍历子集大小、子集和子集的子计划，调用computeCostAndCardOfSubplan方法并构建一个PlanCache对象，该对象存储执行每个子集连接的最小成本方法</p> <p>通过单元测试JoinOptimizerTest和系统测试QueryTest证明我们通过练习4,代码见上述。</p> <h2 id="_3、总结"><a href="#_3、总结" class="header-anchor">#</a> 3、总结</h2> <p>一定要从整体架构上来看，详细仔细看文档.第一次做实验前一头雾水，当多读文档补充相关知识后就会变得容易.</p></div></section> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/VuePressBlog/项目/MIT6.830/lab2.html" class="prev">
          MIT数据库Lab2实验报告
        </a></span> <span class="next"><a href="/VuePressBlog/项目/MIT6.830/lab4.html">
          MIT数据库Lab4实验报告
        </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-2c0089e8><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_1、开始" class="sidebar-link reco-side-_1、开始" data-v-2c0089e8>1、开始</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_1-1-实现提示" class="sidebar-link reco-side-_1-1-实现提示" data-v-2c0089e8>1.1 实现提示</a></li><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_2、优化大纲" class="sidebar-link reco-side-_2、优化大纲" data-v-2c0089e8>2、优化大纲</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_2-1-优化器全貌" class="sidebar-link reco-side-_2-1-优化器全貌" data-v-2c0089e8>2.1 优化器全貌</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_2-2-统计数据估计法" class="sidebar-link reco-side-_2-2-统计数据估计法" data-v-2c0089e8>2.2 统计数据估计法</a></li><li class="level-3" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_2-3、连接排序" class="sidebar-link reco-side-_2-3、连接排序" data-v-2c0089e8>2.3、连接排序</a></li><li class="level-2" data-v-2c0089e8><a href="/VuePressBlog/%E9%A1%B9%E7%9B%AE/MIT6.830/lab3.html#_3、总结" class="sidebar-link reco-side-_3、总结" data-v-2c0089e8>3、总结</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/VuePressBlog/assets/js/app.f42cc359.js" defer></script><script src="/VuePressBlog/assets/js/3.baa1ae3e.js" defer></script><script src="/VuePressBlog/assets/js/1.17eb7108.js" defer></script><script src="/VuePressBlog/assets/js/296.3422295d.js" defer></script>
  </body>
</html>
